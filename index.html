<html lang="ja"><head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>ãƒ‡ãƒªã‚¶ãƒ«ãƒˆ | Delivery Result Tracker</title>
<style>
:root{
  --bg:#050816;--card:#141a2b;--text:#f5f5f5;--muted:#9ca3af;
  --b1:rgba(148,163,184,.16);--b2:rgba(148,163,184,.18);
  --glow:rgba(59,130,246,.35);
  --ok:#22c55e; --warn:#facc15; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;padding:10px 10px 84px;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:radial-gradient(circle at top,#182848 0,#050816 55%,#02030a 100%);
  color:var(--text);
}
h1{font-size:20px;margin:0 0 4px}
.sub{font-size:11px;color:var(--muted);margin:0 0 8px}
.appTitle{text-align:center;margin:6px 0 10px;font-weight:950;letter-spacing:.02em}
.appTitle .jp{font-size:22px;line-height:1.12}
.appTitle .en{font-size:12px;color:var(--muted);font-weight:850;margin-top:4px;letter-spacing:.08em}
.card{
  background:linear-gradient(135deg,rgba(20,26,43,.95),rgba(9,12,24,.98));
  border-radius:14px;padding:10px;margin-bottom:10px;
  border:1px solid rgba(59,169,255,.10);
  box-shadow:0 18px 35px rgba(0,0,0,.8);
  position:relative;overflow:hidden;
}
.card.sparkle::before,.card.sparkle::after{
  content:"";position:absolute;inset:-40%;
  background:
    radial-gradient(circle at 20% 30%,rgba(59,169,255,.12),transparent 55%),
    radial-gradient(circle at 70% 60%,rgba(168,85,247,.10),transparent 55%);
  filter:blur(20px);pointer-events:none;opacity:.7;
  animation:spark 6.2s ease-in-out infinite alternate;
}
.card.sparkle::after{opacity:.45;transform:rotate(-8deg);animation-duration:4.6s}
@keyframes spark{from{transform:translate3d(-8%,-6%,0) rotate(10deg)}to{transform:translate3d(8%,6%,0) rotate(10deg)}}

.goal-met{
  border-color:rgba(250,204,21,.85)!important;
  box-shadow:0 0 0 1px rgba(250,204,21,.16),0 18px 35px rgba(0,0,0,.8)!important;
  background:linear-gradient(135deg,rgba(50,35,0,.45),rgba(20,26,43,.95),rgba(9,12,24,.98))!important;
}
.row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.dash{
  background:rgba(2,6,23,.18);
  border:1px solid var(--b1);
  border-radius:12px;padding:8px;
}
.label{font-size:11px;color:var(--muted)}
.dash-value{font-size:22px;font-weight:800;margin-top:1px}

input[type="text"],textarea,select{
  width:100%;border-radius:12px;border:1px solid var(--b2);
  background:rgba(2,6,23,.25);color:var(--text);
  padding:10px;font-size:16px;outline:none;
}
textarea{min-height:60px;resize:vertical}
select{appearance:auto}

button{
  border:none;border-radius:999px;padding:10px;font-weight:900;cursor:pointer;
  color:#fff;background:linear-gradient(90deg,#3b82f6,#06b6d4);
  box-shadow:0 10px 22px var(--glow);font-size:13px;
}
button:active{transform:translateY(1px)}
.btn-muted{
  background:rgba(148,163,184,.16);
  box-shadow:none;border:1px solid rgba(148,163,184,.18);
  color:rgba(226,232,240,.95);
}
.btn-goal{background:linear-gradient(90deg,#a855f7,#3b82f6);box-shadow:0 8px 18px rgba(168,85,247,.38)}
.btn-quest{background:linear-gradient(90deg,#3b82f6,#06b6d4);box-shadow:0 8px 18px rgba(59,130,246,.55)}
.btn-cash{background:linear-gradient(90deg,#f97316,#facc15);box-shadow:0 8px 18px rgba(249,115,22,.55)}
.btn-danger{background:linear-gradient(90deg,#ef4444,#f97316);box-shadow:0 8px 18px rgba(239,68,68,.45)}

.btn-row{display:flex;gap:8px;margin-top:6px;justify-content:center}
.btn-row button{flex:1;width:auto;text-align:center}

.center-title{text-align:center;font-weight:950;letter-spacing:.02em;margin-bottom:6px}
.top-row{
  padding:8px 10px;border-radius:12px;
  background:radial-gradient(circle at top,#3b82f6 0,#020617 55%);
  border:1px solid rgba(59,130,246,.5);text-align:center;
}
.top-row .label{font-size:12px;color:#e5e7eb}
.top-row .value{font-size:26px;font-weight:900;margin-top:2px;text-shadow:0 10px 22px rgba(0,0,0,.5)}
.top-row-wage .label{font-size:12px;color:#e5e7eb}
.top-row-wage .value{font-size:26px;font-weight:900;margin-top:2px;text-shadow:0 10px 22px rgba(0,0,0,.5)}
.triple{display:flex;gap:6px;margin-top:6px}
.triple>div,.double>div{
  flex:1;min-width:0;
  background:rgba(2,6,23,.18);
  border:1px solid var(--b1);
  border-radius:12px;padding:10px;
}
.k{font-size:11px;color:rgba(156,163,175,.95)}
.v{font-size:18px;font-weight:950;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.double{display:flex;gap:6px;margin-top:6px}
.double .v{font-size:16px}

.ach{
  display:flex;align-items:center;gap:10px;justify-content:space-between;
  margin-top:6px;background:rgba(2,6,23,.18);
  border:1px solid var(--b1);border-radius:12px;padding:10px;
}
.achL,.achR{font-size:12px;font-weight:950;white-space:nowrap}
.achBar{flex:1;height:10px;border-radius:999px;background:rgba(148,163,184,.14);overflow:hidden}
.achFill{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#facc15);border-radius:999px}

.runlist{margin-top:8px;display:none}
.runitem{
  background:rgba(2,6,23,.18);border:1px solid var(--b1);
  border-radius:12px;padding:10px;margin-bottom:8px;font-size:15px;
}
.runitem .small{font-size:12px;color:rgba(156,163,175,.95);margin-top:4px}

/* normal toast */
.toast{
  position:fixed;left:12px;bottom:12px;width:calc(100% - 24px);
  background:rgba(15,23,42,.92);
  border:1px solid rgba(59,130,246,.45);
  border-radius:14px;padding:12px;
  font-weight:950;font-size:14px;line-height:1.35;
  box-shadow:0 18px 40px rgba(0,0,0,.75);
  opacity:0;transform:translateY(12px);transition:.18s ease;
  pointer-events:none;max-height:30vh;overflow:auto;
}
.toast.show{opacity:1;transform:translateY(0)}

/* modal toast (must ack) */
.modalOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;
  padding:12px;z-index:9999;
}
.modalOverlay.show{display:flex;}
.modalToast{
  width:min(520px,100%);
  background:rgba(15,23,42,.96);
  border:1px solid rgba(250,204,21,.55);
  border-radius:16px;padding:14px;
  box-shadow:0 18px 50px rgba(0,0,0,.85);
}
.modalToast .ttl{font-weight:950;font-size:14px;margin-bottom:6px}
.modalToast .msg{font-size:13px;color:rgba(226,232,240,.92);line-height:1.45;margin-bottom:10px}
.modalToast .actions{display:flex;gap:8px}
.modalToast .actions button{flex:1}

/* calendar */
.calBtn{
  margin:8px auto 0;width:min(320px,100%);
  padding:10px 12px;border-radius:999px;
  border:1px solid rgba(148,163,184,.22);
  background:rgba(15,23,42,.6);font-weight:950;
  display:flex;align-items:center;justify-content:center;
  color:rgba(226,232,240,.95);
}
#calendarWrap{display:none;margin-top:10px}
.calList{display:flex;flex-direction:column;gap:6px}
.calDay{
  border-radius:12px;padding:10px;
  background:rgba(2,6,23,.20);
  border:1px solid rgba(148,163,184,.18);
}
.calHead{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer}
.calDate{font-weight:950}
.calMetrics{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;text-align:right}
.calMetrics span{font-size:12px;color:rgba(226,232,240,.88)}
.calMemo{margin-top:6px;font-size:12px;color:rgba(226,232,240,.85);display:none}
.calDay.open .calMemo{display:block}
.calDetails{margin-top:6px;display:none}
.calDay.open .calDetails{display:block}
.calRuns{margin-top:8px;display:none}
.calDay.showruns .calRuns{display:block}

/* online indicator */
.onlineBadge{font-size:12px;font-weight:950;color:var(--ok);margin-left:6px}
.onlineTapHint{font-size:11px;color:rgba(156,163,175,.95);margin-top:4px;text-align:center}

/* delivery input layout */
.deliveryGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px;
  margin-top:6px;
}

/* footer reload */
.footerBar{
  position:fixed;
  left:0; right:0; bottom:0;
  padding:10px 12px;
  background:rgba(5,8,22,.92);
  border-top:1px solid rgba(148,163,184,.18);
  z-index:5000;
  backdrop-filter: blur(8px);
}
.footerVer{font-size:12px;font-weight:950;color:rgba(226,232,240,.85);letter-spacing:.02em}

.footerBar .footerInner{
  width:min(520px,100%);
  margin:0 auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}


/* delivery complete popup (center) */
.centerPopOverlay{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  padding:16px; z-index:9998;
  pointer-events:none;
}
.centerPopOverlay.show{display:flex;}
.centerPop{
  width:min(420px, 88vw);
  max-height:25vh;
  background:rgba(15,23,42,.96);
  border:1px solid rgba(250,204,21,.65);
  border-radius:18px;
  padding:14px 14px 12px;
  box-shadow:0 18px 50px rgba(0,0,0,.85);
  text-align:center;
}
.centerPop .ttl{
  font-weight:950; font-size:16px; margin-bottom:8px;
}
.centerPop .line{
  font-size:13px; color:rgba(226,232,240,.92);
  display:flex; justify-content:space-between; gap:10px;
  padding:2px 0;
}
.centerPop .line .k{color:rgba(156,163,175,.95); font-weight:800;}
.centerPop .line .v{font-weight:950;}



/* delivery complete popup (auto hide) */
.dcOverlay{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,.35);
  z-index:10000;
}

.dcToast{
  width:min(520px,92%);
  background:rgba(15,23,42,.96);
  border:1px solid rgba(59,130,246,.45);
  border-radius:16px;
  padding:14px 14px 12px;
  box-shadow:0 18px 50px rgba(0,0,0,.85);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.dcOverlay.show{display:flex;}
.dcCard{
  width:min(520px, 92vw);
  max-width:520px;
  background:rgba(15,23,42,.96);
  border:1px solid rgba(59,130,246,.45);
  border-radius:16px;
  padding:14px 14px 12px;
  box-shadow:0 18px 50px rgba(0,0,0,.85);
  text-align:center;
}
.dcTitle{font-weight:950;font-size:18px;margin-bottom:10px;text-align:center;}
.dcBig{
  font-weight:950;
  font-size:16px;
  line-height:1.6;
  text-align:center;
}
.dcNowLine{margin:2px 0}
.dcNowLine span{font-size:18px}
.dcSpacer{height:10px}

.dcGrid{display:grid;grid-template-columns:1fr;gap:6px;}
.dcLine{display:flex;justify-content:space-between;gap:10px;
  background:rgba(2,6,23,.22);
  border:1px solid rgba(148,163,184,.16);
  border-radius:12px;padding:10px 12px;
}
.dcKey{font-size:12px;color:rgba(156,163,175,.95);font-weight:850;}
.dcVal{font-size:14px;font-weight:950;color:rgba(226,232,240,.95);}


/* quick memo */
#quickMemoCard .subtitle{ color:#666; font-size:12px; }
.qm-item{ padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin-top:8px; cursor:pointer; }
.qm-item.qm-hit{
  border-color: rgba(59,130,246,.55);
  background: rgba(59,130,246,.10);
}

.qm-top{ display:flex; gap:10px; align-items:baseline; }
.qm-title{ font-weight:700; font-size:14px; flex:1; }
.qm-meta{ font-size:11px; color:#666; white-space:nowrap; }
.qm-snippet{ margin-top:6px; font-size:12px; color:#333; line-height:1.35; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
mark{ padding:0 2px; border-radius:3px; }

/* QuickMemo ì¤‘ìš”åº¦ãƒ•ãƒ©ã‚° */
.qm-flagbar{ display:flex; gap:8px; margin-top:10px; justify-content:center; flex-wrap:wrap; }
.qm-flagbtn{ padding:8px 10px; border-radius:10px; border:1px solid #ddd; background:#fff; font-size:13px; }
.qm-flagbtn.active{ border-color:#222; box-shadow:0 0 0 2px rgba(0,0,0,0.08); }
.qm-item.flag-yellow{ border-left:6px solid #f1c40f; }
.qm-item.flag-red{ border-left:6px solid #e74c3c; }
.qm-flagbadge{ display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; margin-left:6px; border:1px solid #ddd; }
.qm-flagbadge.yellow{ border-color:#f1c40f; }
.qm-flagbadge.red{ border-color:#e74c3c; }

</style>
</head>
<body>
<div class="appTitle"><div class="jp">ãƒ‡ãƒªã‚¶ãƒ«ãƒˆ</div><div class="en">Delivery Result Tracker</div></div>
<div class="card sparkle" id="mainStatsCard">
  <div class="top-row">
    <div class="label">ç·å£²ä¸Šï¼ˆã‚¯ã‚¨ã‚¹ãƒˆè¾¼ã¿ï¼‰</div>
    <div class="value">Â¥<span id="totalSales">0</span></div>
  </div>

  <div class="ach" id="achRow" style="display:none;">
    <div class="achL">é”æˆç‡</div>
    <div class="achBar"><div class="achFill" id="achFill"></div></div>
    <div class="achR" id="achText">0%</div>
  </div>

    <div class="top-row top-row-wage" style="margin-top:6px;">
    <div class="label">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚çµ¦æ›ç®—</div>
    <div class="value">Â¥<span id="onlineWage">0</span>/h</div>
  </div>

  <div class="row" style="margin-top:6px;">
    <div class="dash"><div class="label">é…é”å›æ•°</div><div class="dash-value"><span id="runCount">0</span>å›</div></div>
    <div class="dash" id="onlineTimeBox"><div class="label">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“<span id="onlineBadge" class="onlineBadge" style="display:none;">online</span></div><div class="dash-value"><span id="onlineTime">00:00</span></div></div>
  </div>

  <div class="row" style="margin-top:6px;">
    <div class="dash"><div class="label">å®Ÿåƒæ™‚é–“</div><div class="dash-value"><span id="workTime">00:00</span></div></div>
    <div class="dash"><div class="label">å®Ÿåƒæ™‚çµ¦æ›ç®—</div><div class="dash-value">Â¥<span id="workWage">0</span>/h</div></div>
  </div>

  <div class="onlineTapHint">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“ã‚’ã‚¿ãƒƒãƒ—ï¼šã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åˆ‡æ›¿ãƒ»æ™‚åˆ»ä¿®æ­£</div>
</div>

<div class="card">
  <div class="center-title" style="font-size:16px;">é…é”æ¡ˆä»¶</div>

  <div class="deliveryGrid">
    <div>
      <div class="label">ä»¶æ•°ï¼ˆä»¶ï¼‰</div>
      <select id="inputCount">
        <option value="1" selected="">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <div>
      <div class="label">é‡‘é¡ï¼ˆå††ï¼‰</div>
      <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputAmount" placeholder="ä¾‹: 1320">
    </div>

    <div>
      <div class="label">ç¾é‡‘ä»£å¼•ãï¼ˆå††ï¼‰</div>
      <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCashCollected" placeholder="ä¾‹: 300">
    </div>

    <div>
      <div class="label">æ™‚é–“ï¼ˆåˆ†ï¼‰</div>
      <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputMinutes" placeholder="ä¾‹: 28">
    </div>
  </div>

  <div class="btn-row">
    <button class="btn-muted" id="btnToggleRunList">é…é”æ¸ˆã¿æ¡ˆä»¶</button>
    <button id="btnAddRun">è¿½åŠ </button>
  </div>
  <div id="runList" class="runlist"></div>
</div>

<div class="card sparkle" id="topSummaryCard">
  <div class="row">
    <div class="dash"><div class="label">ã‚¯ã‚¨ã‚¹ãƒˆåˆè¨ˆ</div><div class="dash-value">Â¥<span id="questSum">0</span></div></div>
    <div class="dash"><div class="label">ç¾é‡‘ä»£å¼•ãåˆè¨ˆ</div><div class="dash-value">Â¥<span id="cashSum">0</span></div></div>
    <div class="dash"><div class="label">ç›®æ¨™å›æ•°</div><div class="dash-value"><span id="targetRunsLabel">ãªã—</span></div></div>
    <div class="dash"><div class="label">ç›®æ¨™é‡‘é¡</div><div class="dash-value"><span id="targetAmountLabel">ãªã—</span></div></div>
  </div>

  <div class="row" style="margin-top:6px;">
    <div><div class="label">ç›®æ¨™å›æ•°ï¼ˆä»»æ„ï¼‰</div><input type="text" inputmode="numeric" pattern="[0-9]*" id="inputTargetRuns" placeholder="æœªè¨­å®šã§ã‚‚OK"></div>
    <div><div class="label">ç›®æ¨™é‡‘é¡ï¼ˆä»»æ„ãƒ»å††ï¼‰</div><input type="text" inputmode="numeric" pattern="[0-9]*" id="inputTargetAmount" placeholder="æœªè¨­å®šã§ã‚‚OK"></div>
  </div>

  <div class="btn-row">
    <button class="btn-muted" id="btnGoalReset">ç›®æ¨™ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="btn-goal" id="btnGoalSet">ç›®æ¨™è¨­å®š</button>
  </div>
</div>

<div class="card" id="calendarCard">
<div class="center-title" id="calendarTitle" style="font-size:16px;cursor:pointer;">å£²ä¸Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
<button class="calBtn" id="calendarToggle" type="button">è¡¨ç¤ºã™ã‚‹</button>
<div id="calendarWrap" style="display: none;">
<div class="sub" style="margin:0 0 6px;">æ—¥åˆ¥ï¼šå£²ä¸Š/æ™‚é–“/ä»¶æ•°/æ™‚çµ¦/ç¾é‡‘ä»£å¼•ã/ã‚¯ã‚¨ã‚¹ãƒˆ ï¼‹ ãƒ¡ãƒ¢</div>
<div class="calList" id="calendarList"></div>
</div>
</div>

<div class="card" id="quickMemoCard">
  <div class="center-title" style="font-size:16px;">ãƒ¡ãƒ¢ï¼ˆç«¯æœ«å†…ã®ã¿ï¼‰</div>
  <div class="subtitle" style="text-align:center; margin-top:2px;">â€»å…±æœ‰ãƒ»é€ä¿¡ãªã— / ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆæ¤œç´¢é€£æºOK</div>

  <div class="row" style="margin-top:8px;">
    <div style="flex:1;">
      <div class="label">æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰</div>
      <input type="text" id="qmSearch" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å / å»ºç‰©å / ä½•ã§ã‚‚">
    </div>
    <div style="width:110px;">
      <div class="label">&nbsp;</div>
      <button class="btn-goal" id="btnQmAdd" style="width:100%;">ï¼‹è¿½åŠ </button>
    </div>
  </div>

  <div class="btn-row" style="margin-top:8px;">
    <button class="btn-muted" id="btnQmExport">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button class="btn-muted" id="btnQmImport">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <input type="file" id="qmImportFile" accept="application/json" style="display:none;">
    <div id="qmCount" class="sub" style="text-align:center; margin:6px 0 0; display:block;">ç™»éŒ²ä»¶æ•°ï¼š0ä»¶</div>

</div>

  <div id="qmResultsWrap" style="display:none; margin-top:10px;">
    <div class="label" id="qmResultsLabel">æ¤œç´¢çµæœ</div>
    <div id="qmList" class="list"></div>
  </div>
</div>

<!-- Quick memo modal -->
<div id="qmOverlay" class="dcOverlay" aria-hidden="true" style="display:none;">
  <div class="dcToast" style="max-width:640px;">
    <div class="dcTitle" id="qmModalTitle">ãƒ¡ãƒ¢</div>
    <div class="row" style="margin-top:10px;">
      <div style="flex:1;">
        <div class="label">ä¸€è¨€ï¼ˆä»»æ„ï¼‰</div>
        <input type="text" id="qmTitle" placeholder="ä¾‹ï¼šâš ï¸ ç¾é‡‘åºŠç½®ã">

    <div class="qm-flagbar" aria-label="é‡è¦åº¦ãƒ•ãƒ©ã‚°">
      <button type="button" class="qm-flagbtn" id="btnFlagNone">ãƒ•ãƒ©ã‚°ãªã—</button>
      <button type="button" class="qm-flagbtn" id="btnFlagYellow">âš ï¸ æ³¨æ„ï¼ˆé»„ï¼‰</button>
      <button type="button" class="qm-flagbtn" id="btnFlagRed">â›” å±é™ºï¼ˆèµ¤ï¼‰</button>
      <input type="hidden" id="qmFlag" value="none">
    </div>

      </div>
    </div>
    <div style="margin-top:10px;">
      <div class="label">æœ¬æ–‡ï¼ˆã‚¹ã‚¯ã‚·ãƒ§ä¸¸ã‚³ãƒ”OKï¼‰</div>
      <textarea id="qmBody" rows="8" style="width:100%; resize:vertical;" placeholder="ã“ã“ã«è²¼ã‚‹ï¼ˆæ”¹è¡ŒOKï¼‰"></textarea>
    </div>

    <div class="btn-row" style="margin-top:10px;">
      <button class="btn-muted" id="btnQmCancel">é–‰ã˜ã‚‹</button>
      <button class="btn-danger" id="btnQmDelete" style="display:none;">å‰Šé™¤</button>
      <button class="btn-goal" id="btnQmSave">ä¿å­˜</button>
    </div>
    <div class="subtitle" id="qmHint" style="text-align:center; margin-top:6px;">ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</div>
  </div>
</div>
<div class="card">
<div class="center-title" style="font-size:16px;">ã‚¯ã‚¨ã‚¹ãƒˆ &amp; ä»Šæ—¥ã®ãƒ¡ãƒ¢ &amp; ç¾é‡‘ãƒãƒƒãƒ—</div>
<div class="row" style="margin-top:6px;">
<div><div class="label">ã‚¯ã‚¨ã‚¹ãƒˆé‡‘é¡ï¼ˆå††ï¼‰</div><input id="inputQuest" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹: 1200" type="text"></div>
<div><div class="label">ç¾é‡‘ãƒãƒƒãƒ—ï¼ˆå††ï¼‰</div><input id="inputCashTip" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹: 300" type="text"></div>
</div>
<div style="margin-top:6px;">
<div class="label">ä»Šæ—¥ã®ãƒ¡ãƒ¢</div>
<textarea id="inputMemo" placeholder="ãƒ¡ãƒ¢"></textarea>
</div>
<div class="btn-row">
<button class="btn-quest" id="btnAddQuest">ã‚¯ã‚¨ã‚¹ãƒˆè¿½åŠ </button>
<button class="btn-cash" id="btnAddCashTip">ç¾é‡‘ãƒãƒƒãƒ—</button>
</div>
<div class="btn-row">
<button class="btn-danger" id="btnResetQuestToday">ã‚¯ã‚¨ã‚¹ãƒˆä»Šæ—¥åˆ†ãƒªã‚»ãƒƒãƒˆ</button>
<button class="btn-danger" id="btnResetAll">å…¨ã¦ãƒªã‚»ãƒƒãƒˆ</button>
</div>
</div>
<div class="card">
<div class="center-title" style="font-size:16px;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</div>
<div class="btn-row">
<button class="" id="btnOffline" type="button">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</button>
<button id="btnOnline" type="button" class="btn-muted">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</button>
</div>
<div class="sub" id="onlineState" style="margin:6px 0 0;text-align:center;display:none;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸­</div>
</div>
<div class="toast" id="toast"></div>
<!-- modal -->
<div aria-hidden="true" class="modalOverlay" id="modalOverlay">
<div class="modalToast">
<div class="ttl" id="modalTitle">é€šçŸ¥</div>
<div class="msg" id="modalMsg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
<div class="actions" id="modalActions"></div>
</div>
</div>
<div class="footerBar">
  <div class="footerInner">
    <div class="footerVer" id="footerVer">v13.9</div>
    <button class="btn-muted" id="btnReload" type="button">æ›´æ–°</button>
  </div>
</div>

<!-- delivery complete popup -->
<div id="dcOverlay" class="dcOverlay" aria-hidden="true">
  <div class="dcToast">
    <div class="dcTitle" id="dcTitle">âœ¨ğŸ’°é…é”å®Œäº†ğŸ’°âœ¨</div>

    <div class="dcBig">
      <div class="dcNowLine">ä»Šå›ã®å£²ä¸Šï¼š<span id="dcNowSales">Â¥0</span></div>
      <div class="dcNowLine">é…é”æ™‚é–“ï¼š<span id="dcNowMinutes">0åˆ†</span></div>
      <div class="dcNowLine">æ™‚çµ¦æ›ç®—ï¼š<span id="dcNowWage">Â¥0/h</span></div>
    </div>

    <div class="dcSpacer"></div>

    <div class="dcGrid" id="dcGrid">
      <div class="dcLine"><span>ç·å£²ä¸Š</span><span id="dcSales">Â¥0</span></div>
      <div class="dcLine"><span>ç·é…é”ä»¶æ•°</span><span id="dcRuns">0å›</span></div>
      <div class="dcLine"><span>ç·ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚çµ¦æ›ç®—</span><span id="dcOnlineWage">Â¥0/h</span></div>
      <div class="dcLine"><span>ç·ç¾é‡‘ä»£å¼•ã</span><span id="dcCash">Â¥0</span></div>
    </div>
  </div>
</div>
  



<!-- Quick memo maintenance (hidden) -->
<div id="qmMaintOverlay" class="dcOverlay" aria-hidden="true" style="display:none;">
  <div class="dcCard" style="max-width:520px;">
    <div class="dcTitle">ãƒ¡ãƒ¢ç®¡ç†</div>
    <div class="subtitle" style="text-align:center; margin-top:-2px;">é•·æŠ¼ã—ã§é–‹ã / èª¤æ“ä½œé˜²æ­¢ã®ãŸã‚ç¢ºèªã‚ã‚Š</div>
    <div class="btn-row" style="margin-top:10px;">
      <button class="btn-muted" id="btnQmMaintExport">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn-muted" id="btnQmMaintImport">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    </div>
    <button class="btn-danger" id="btnQmResetAllMemos" style="width:100%; margin-top:10px;">å…¨ãƒ¡ãƒ¢ã‚’å‰Šé™¤</button>
    <button class="btn-muted" id="btnQmMaintClose" style="width:100%; margin-top:10px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>

(() => {
  "use strict";

  const APP_VERSION = "v13.9";
  const STORE_KEY = "ddt_store_v12";
const safeEl = (id) => {
    const n = document.getElementById(id);
    return n || null;
  };
  const toInt=(s)=>{if(s==null)return 0;const n=parseInt(String(s).replace(/[^\d-]/g,""),10);return Number.isFinite(n)?n:0;};
  const fmtYen=(n)=>String(Math.max(0,Math.round(n))).replace(/\B(?=(\d{3})+(?!\d))/g,",");

  function businessDayKey(ts=Date.now()){
    const d=new Date(ts); d.setMinutes(d.getMinutes()-240);
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),day=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function businessWindow(dayKey){
    const [y,m,d]=dayKey.split("-").map(Number);
    const start=new Date(y,m-1,d,4,0,0,0).getTime();
    return {start,end:start+86400000};
  }
  function todayKey(){return businessDayKey(Date.now());}

  function fmtDayKey(dayKey){
    const [y,m,d]=dayKey.split("-").map(Number);
    const mm=String(m).padStart(2,"0");
    const dd=String(d).padStart(2,"0");
    return `${y} ${mm}/${dd}`;
  }

  const defaultState={
    runsLog:[], quest:[], cashTip:[],
    goal:{runs:0,amount:0},
    online:{isOn:false,startAt:0,accumulatedMs:0,lastKey:""},
    onlineByDay:{}, // {dayKey: ms}

    memos:{}, // {dayKey: text}
    quickMemos:[], // [{id,title,body,createdAt,updatedAt}]
    calendarOpen:false
  };

  function structuredClonePoly(obj){ return JSON.parse(JSON.stringify(obj)); }
  function loadState(){
    try{
      const raw=localStorage.getItem(STORE_KEY);
      if(!raw) return structuredClonePoly(defaultState);
      const s=JSON.parse(raw);
      const base=structuredClonePoly(defaultState);
      // merge (shallow)
      const merged = Object.assign(base,s);
      // deep-ish fix
      merged.goal = Object.assign(structuredClonePoly(defaultState.goal), s.goal||{});
      merged.online = Object.assign(structuredClonePoly(defaultState.online), s.online||{});
      merged.memos = Object.assign({}, s.memos||{});
      merged.calendarOpen = !!s.calendarOpen;
      return merged;
    }catch(e){return structuredClonePoly(defaultState);}
  }
  let state = loadState();
  let dirty = false;
  let lastSaveAt = 0;
  const markDirty = ()=>{ dirty = true; };

  function saveState(force=false){
    state.calendarOpen = calendarOpen;
    const now = Date.now();
    if(!force && !dirty && (now - lastSaveAt) < 15000) return;
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){}
    dirty = false;
    lastSaveAt = now;
  }

  // toasts
  let toastTimer=null;
  function showToast(msg){
    const t=safeEl("toast"); if(!t) return;
    t.textContent=msg; t.classList.add("show");
    clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove("show"),5000);
  }

  // delivery complete popup (center, auto hide)
  let centerPopTimer = null;
  function showDeliveryCompletePopup(nowRun){
    const ov=safeEl("dcOverlay"); if(!ov) return;

    const dayKey=todayKey();
    const t=totalsForDay(dayKey);

    // totals
    const onlineH = currentOnlineMs()/3600000;
    const onlineW = onlineH>0 ? Math.floor(t.sales/onlineH) : 0;

    if(safeEl("dcSales")) safeEl("dcSales").textContent = `Â¥${fmtYen(t.sales)}`;
    if(safeEl("dcRuns")) safeEl("dcRuns").textContent = `${fmtYen(t.count)}å›`;
    if(safeEl("dcOnlineWage")) safeEl("dcOnlineWage").textContent = `Â¥${fmtYen(onlineW)}/h`;
    if(safeEl("dcCash")) safeEl("dcCash").textContent = `Â¥${fmtYen(t.cashSum)}`;

    // current run
    const amt = nowRun?.amount || 0;
    const mins = nowRun?.minutes || 0;
    const wage = (mins>0) ? Math.floor(amt / (mins/60)) : 0;
    if(safeEl("dcNowSales")) safeEl("dcNowSales").textContent = `Â¥${fmtYen(amt)}`;
    if(safeEl("dcNowMinutes")) safeEl("dcNowMinutes").textContent = `${fmtYen(mins)}åˆ†`;
    if(safeEl("dcNowWage")) safeEl("dcNowWage").textContent = `Â¥${fmtYen(wage)}/h`;

    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");
    clearTimeout(centerPopTimer);
    centerPopTimer=setTimeout(()=>{ closeDeliveryCompletePopup(); }, 10000);
  }

function closeDeliveryCompletePopup(){
  const ov=safeEl("dcOverlay"); if(!ov) return;
  ov.classList.remove("show");
  ov.setAttribute("aria-hidden","true");
  if(centerPopTimer){ clearTimeout(centerPopTimer); centerPopTimer=null; }
}




  // modal (must ack)
  function showModal({title="é€šçŸ¥", msg="", buttons=[{text:"OK", type:"primary", onClick:()=>{}}]}){
    const ov = safeEl("modalOverlay");
    const ttl = safeEl("modalTitle");
    const mm = safeEl("modalMsg");
    const acts = safeEl("modalActions");
    if(!ov||!ttl||!mm||!acts){ return; }

    ttl.textContent = title;
    mm.textContent = msg;
    acts.innerHTML = "";
    buttons.forEach((b)=>{
      const btn=document.createElement("button");
      btn.textContent=b.text||"OK";
      if(b.type==="muted") btn.className="btn-muted";
      else if(b.type==="danger") btn.className="btn-danger";
      // else default gradient button
      btn.addEventListener("click",()=>{
        // Close first, then run the callback.
        // (Allows callbacks to open another modal using the same overlay.)
        ov.classList.remove("show");
        ov.setAttribute("aria-hidden","true");
        try{ b.onClick && b.onClick(); }catch(e){}
      });
      acts.appendChild(btn);
    });
    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");
  }
  function dayBoundaryResetIfNeeded(){
    const key=todayKey();
    const prevKey = state.online.lastKey || key;
    if(prevKey !== key){
      // commit previous day's online time before reset
      if(!state.onlineByDay) state.onlineByDay = {};
      const o=state.online||{};
      let rawMs = (o.accumulatedMs||0);
      if(o.isOn && o.startAt) rawMs += (Date.now()-o.startAt);
      state.onlineByDay[prevKey] = Math.max(0, rawMs);

      // reset per business day
      state.online = {isOn:false,startAt:0,accumulatedMs:0,lastKey:key};
    }
  }

  function totalsForDay(dayKey){
    const {start,end}=businessWindow(dayKey);
    const runs=state.runsLog.filter(r=>r.ts>=start&&r.ts<end);
    const quest=state.quest.filter(q=>q.ts>=start&&q.ts<end);
    const amountSum=runs.reduce((a,r)=>a+(r.amount||0),0);
    const questSum=quest.reduce((a,q)=>a+(q.amount||0),0);
    const sales=amountSum+questSum; // ãƒãƒƒãƒ—ã¯å«ã‚ãªã„
    const count=runs.reduce((a,r)=>a+(r.count||0),0);
    const workMinutes=runs.reduce((a,r)=>a+(r.minutes||0),0);
    const cashSum=runs.reduce((a,r)=>a+(r.cashCollected||0),0);
    return {sales,count,workMs:workMinutes*60000,questSum,cashSum};
  }

  function onlineMsForDay(dayKey){
    if(dayKey===todayKey()) return currentOnlineMs();
    if(state.onlineByDay && typeof state.onlineByDay[dayKey]==="number") return state.onlineByDay[dayKey];
    return 0;
  }

  function currentOnlineMs(){
    dayBoundaryResetIfNeeded();
    const o=state.online;
    let ms=o.accumulatedMs||0;
    if(o.isOn && o.startAt) ms += Date.now()-o.startAt;
    return Math.max(0,ms);
  }
  function fmtHHMM(ms){
    const totalMin=Math.floor(ms/60000);
    const hh=String(Math.floor(totalMin/60)).padStart(2,"0");
    const mm=String(totalMin%60).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  // run list
  let runListOpen=false;
  function renderRunList(){
  const box=safeEl("runList"); if(!box) return;
  const {start,end}=businessWindow(todayKey());
  const runs=state.runsLog.filter(r=>r.ts>=start&&r.ts<end).slice().reverse();
  if(!runs.length){
    box.innerHTML=`<div class="sub" style="margin:6px 0 0;">ã¾ã ãªã—</div>`;
    return;
  }
  box.innerHTML=runs.map(r=>{
    const wage=r.minutes>0?Math.floor(r.amount/(r.minutes/60)):0;
    const id=escapeHtml(r.id);
    return `<div class="runitem" data-runid="${id}">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
        <div><strong>Â¥${fmtYen(r.amount)}</strong> / ${r.minutes}åˆ† / ${r.count||1}ä»¶</div>
        <button type="button" class="btn-muted" data-edit="${id}" style="padding:8px 12px;font-weight:950;">ä¿®æ­£</button>
      </div>
      <div class="small">æ™‚çµ¦æ›ç®—ï¼šÂ¥${fmtYen(wage)}/hã€€ç¾é‡‘ä»£å¼•ãï¼šÂ¥${fmtYen(r.cashCollected||0)}</div>
    </div>`;
  }).join("");

  box.querySelectorAll('button[data-edit]').forEach(btn=>{
    btn.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      const id=btn.getAttribute('data-edit');
      openRunEditModal(id);
    });
  });
}

function openRunEditModal(runId){
  const run = state.runsLog.find(r=>String(r.id)===String(runId));
  if(!run){ showToast("å¯¾è±¡ã®é…é”ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚‰ãªã„"); return; }

  const ov = safeEl("modalOverlay");
  const ttl = safeEl("modalTitle");
  const mm  = safeEl("modalMsg");
  const acts= safeEl("modalActions");
  if(!ov||!ttl||!mm||!acts) return;

  ttl.textContent="é…é”ãƒ­ã‚°ã‚’ä¿®æ­£";
  mm.innerHTML = `
    <div class="row" style="gap:8px;">
      <div>
        <div class="label">ä»¶æ•°ï¼ˆä»¶ï¼‰</div>
        <select id="tmpEditCount">
          ${[1,2,3,4,5].map(n=>`<option value="${n}" ${Number(run.count||1)===n?'selected':''}>${n}</option>`).join("")}
        </select>
      </div>
      <div>
        <div class="label">æ™‚é–“ï¼ˆåˆ†ï¼‰</div>
        <input type="text" id="tmpEditMinutes" inputmode="numeric" pattern="[0-9]*" value="${fmtYen(run.minutes||0).replace(/,/g,'')}" />
      </div>
    </div>
    <div class="row" style="gap:8px;margin-top:8px;">
      <div>
        <div class="label">é‡‘é¡ï¼ˆå††ï¼‰</div>
        <input type="text" id="tmpEditAmount" inputmode="numeric" pattern="[0-9]*" value="${fmtYen(run.amount||0).replace(/,/g,'')}" />
      </div>
      <div>
        <div class="label">ç¾é‡‘ä»£å¼•ãï¼ˆå††ï¼‰</div>
        <input type="text" id="tmpEditCash" inputmode="numeric" pattern="[0-9]*" value="${fmtYen(run.cashCollected||0).replace(/,/g,'')}" />
      </div>
    </div>
    <div style="font-size:11px;color:rgba(156,163,175,.95);margin-top:8px;">
      â€»æ—¥ä»˜ã¯å¤‰æ›´ã—ã¾ã›ã‚“ï¼ˆãã®ã¾ã¾ï¼‰
    </div>
  `;

  acts.innerHTML="";
  const btnCancel=document.createElement("button");
  btnCancel.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
  btnCancel.className="btn-muted";
  btnCancel.addEventListener("click",()=>{
    ov.classList.remove("show");
    ov.setAttribute("aria-hidden","true");
  });

  const btnSave=document.createElement("button");
  btnSave.textContent="åæ˜ ";
  btnSave.addEventListener("click",()=>{
    const count = Math.max(1, toInt(safeEl("tmpEditCount")?.value) || 1);
    const minutes = Math.max(0, toInt(safeEl("tmpEditMinutes")?.value));
    const amount  = Math.max(0, toInt(safeEl("tmpEditAmount")?.value));
    const cashCollected = Math.max(0, toInt(safeEl("tmpEditCash")?.value));

    if(!minutes || !amount){ showToast("æ™‚é–“ï¼ˆåˆ†ï¼‰ã¨é‡‘é¡ï¼ˆå††ï¼‰ã¯å¿…é ˆ"); return; }

    run.count = count;
    run.minutes = minutes;
    run.amount = amount;
    run.cashCollected = cashCollected;

    ov.classList.remove("show");
    ov.setAttribute("aria-hidden","true");
    showToast("é…é”ãƒ­ã‚°ã‚’ä¿®æ­£ã—ãŸ");
    updateUI();
  });

  acts.appendChild(btnCancel);
  acts.appendChild(btnSave);

  ov.classList.add("show");
  ov.setAttribute("aria-hidden","false");
}

  function autoFixOnlineByFirstRunIfNeeded(){
    // Only for today
    const key=todayKey();
    const {start,end}=businessWindow(key);
    const runs=state.runsLog.filter(r=>r.ts>=start&&r.ts<end).slice().sort((a,b)=>a.ts-b.ts);
    if(!runs.length) return;
    const first=runs[0];
    const firstMs=(first.minutes||0)*60000;
    if(!firstMs) return;

    const onlineMs=currentOnlineMs();
    if(onlineMs >= firstMs) return;

    const o=state.online;
    const need = firstMs - onlineMs;

    // If currently on, move startAt earlier
    if(o.isOn && o.startAt){
      o.startAt = o.startAt - need;
    }else{
      // not on -> bump accumulated
      o.accumulatedMs = (o.accumulatedMs||0) + need;
    }
  }

  function addRun(){
    markDirty();
    const minutes=toInt(safeEl("inputMinutes")?.value);
    const amount=toInt(safeEl("inputAmount")?.value);
    const cashCollected=toInt(safeEl("inputCashCollected")?.value);
    const count=Math.max(1,toInt(safeEl("inputCount")?.value)||1);
    if(!minutes || !amount){ showToast("æ™‚é–“ï¼ˆåˆ†ï¼‰ã¨é‡‘é¡ï¼ˆå††ï¼‰ã‚’å…¥åŠ›ã—ã¦ã­"); return; }

    // id generation safe
    const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+Math.random();

    state.runsLog.push({id,ts:Date.now(),minutes,amount,cashCollected,count});
    if(safeEl("inputMinutes")) safeEl("inputMinutes").value="";
    if(safeEl("inputAmount")) safeEl("inputAmount").value="";
    if(safeEl("inputCashCollected")) safeEl("inputCashCollected").value="";
    if(safeEl("inputCount")) safeEl("inputCount").value="1";

    // online auto fix (v12)
    autoFixOnlineByFirstRunIfNeeded();

    updateUI();
    showDeliveryCompletePopup({amount, minutes});
  }

  function addQuest(){
    markDirty();
    const a=toInt(safeEl("inputQuest")?.value);
    if(!a){showToast("ã‚¯ã‚¨ã‚¹ãƒˆé‡‘é¡ã‚’å…¥ã‚Œã¦ã­");return;}
    const id=(crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+Math.random();
    state.quest.push({id,ts:Date.now(),amount:a});
    if(safeEl("inputQuest")) safeEl("inputQuest").value="";
    showToast(`ã‚¯ã‚¨ã‚¹ãƒˆè¿½åŠ ï¼šÂ¥${fmtYen(a)}`);
    updateUI();
  }
  function addCashTip(){
    markDirty();
    const a=toInt(safeEl("inputCashTip")?.value);
    if(!a){showToast("ç¾é‡‘ãƒãƒƒãƒ—é‡‘é¡ã‚’å…¥ã‚Œã¦ã­");return;}
    const id=(crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+Math.random();
    state.cashTip.push({id,ts:Date.now(),amount:a});
    if(safeEl("inputCashTip")) safeEl("inputCashTip").value="";
    showToast(`ç¾é‡‘ãƒãƒƒãƒ—ï¼šÂ¥${fmtYen(a)}ï¼ˆâ€»ç·å£²ä¸Šã«å…¥ã‚Œãªã„ï¼‰`);
    updateUI();
  }
  function resetQuestToday(){
    markDirty();
    const key=todayKey();
    const {start,end}=businessWindow(key);
    const before=state.quest.length;
    state.quest = state.quest.filter(q=>!(q.ts>=start && q.ts<end));
    const removed = before - state.quest.length;
    showToast(removed>0 ? `ä»Šæ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼š${removed}ä»¶` : "ä»Šæ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆã¯0ä»¶");
    updateUI();
  }

  function setGoal(){
    markDirty();
    state.goal.runs=toInt(safeEl("inputTargetRuns")?.value);
    state.goal.amount=toInt(safeEl("inputTargetAmount")?.value);
    showToast("ç›®æ¨™ã‚’è¨­å®šã—ãŸ");
    updateUI();
  }
  function resetGoal(){
    markDirty();
    state.goal={runs:0,amount:0};
    if(safeEl("inputTargetRuns")) safeEl("inputTargetRuns").value="";
    if(safeEl("inputTargetAmount")) safeEl("inputTargetAmount").value="";
    showToast("ç›®æ¨™ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸ");
    updateUI();
  }

  function setOnline(on, mode="manual"){
    markDirty();
    dayBoundaryResetIfNeeded();
    const o=state.online;
    if(on){
      if(!o.isOn){ o.isOn=true; o.startAt=Date.now(); o.lastKey=todayKey(); }
    }else{
      if(o.isOn){
        o.accumulatedMs=(o.accumulatedMs||0)+(Date.now()-(o.startAt||Date.now()));
        o.startAt=0; o.isOn=false;
        if(!state.onlineByDay) state.onlineByDay = {};
        state.onlineByDay[todayKey()] = Math.max(0, o.accumulatedMs||0);
      }
    }
    // ui classes
    const bOn=safeEl("btnOnline"), bOff=safeEl("btnOffline");
    if(bOn && bOff){
      if(o.isOn){
        bOn.classList.remove("btn-muted");
        bOff.classList.add("btn-muted");
      }else{
        bOn.classList.add("btn-muted");
        bOff.classList.remove("btn-muted");
      }
    }
    updateUI();
  }

  function confirmOffline(){
    // Require explicit confirmation before going offline (manual actions)
    if(!state.online.isOn){
      showToast("ã™ã§ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã ã‚ˆ");
      return;
    }
    showModal({
      title:"ç¢ºèª",
      msg:"ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ã™ã‚‹ï¼Ÿ",
      buttons:[
        {text:"ã‚„ã‚ã‚‹", type:"muted", onClick:()=>{}},
        {text:"OK", type:"primary", onClick:()=>setOnline(false,"manual")}
      ]
    });
  }

  function openOnlineTimeEditor(){
    // default: if online is ON, we allow setting start; if OFF allow setting start/end and compute accumulated
    const key=todayKey();
    dayBoundaryResetIfNeeded();
    const o=state.online;

    // use prompt-like modal with simple text inputs
    showModal({
      title:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“",
      msg:"ã‚„ã‚ŠãŸã„æ“ä½œã‚’é¸ã‚“ã§ã­ã€‚",
      buttons:[
        {text: o.isOn ? "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³" : "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³", type:"primary", onClick:()=>{
          if(o.isOn) confirmOffline();
          else setOnline(true,"manual");
        }},
        {text:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“ã‚’æ‰‹å…¥åŠ›", type:"muted", onClick:()=>openTimeInputModal()},
        {text:"é–‰ã˜ã‚‹", type:"muted", onClick:()=>{}}
      ]
    });
  }

    function openTimeInputModal(dayKey=null){

  function openDayEditor(dayKey){
    showModal({
      title:`${fmtDayKey(dayKey)}ï¼ˆç·¨é›†ï¼‰`,
      msg:"ä¿®æ­£ã—ãŸã„é …ç›®ã‚’é¸ã‚“ã§ã­ã€‚",
      buttons:[
        {text:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“ã‚’ç·¨é›†", type:"primary", onClick:()=>openTimeInputModal(dayKey)},
        {text:"ãƒ¡ãƒ¢ã‚’ç·¨é›†", type:"muted", onClick:()=>openMemoEditModal(dayKey)},
        {text:"é–‰ã˜ã‚‹", type:"muted", onClick:()=>closeModal()}
      ]
    });
  }

  function openMemoEditModal(dayKey){
    const ov = safeEl("modalOverlay");
    const ttl = safeEl("modalTitle");
    const mm  = safeEl("modalMsg");
    const acts= safeEl("modalActions");
    if(!ov||!ttl||!mm||!acts) return;

    ttl.textContent = `${fmtDayKey(dayKey)} ãƒ¡ãƒ¢`;
    const cur = (state.memos && state.memos[dayKey]) ? state.memos[dayKey] : "";

    mm.innerHTML = `
      <div style="margin-top:8px;">
        <textarea id="tmpMemoDay" rows="5" style="width:100%;box-sizing:border-box;border-radius:12px;border:1px solid rgba(148,163,184,.25);padding:10px;font-size:16px;background:rgba(2,6,23,.18);color:rgba(226,232,240,.95);">${escapeHtml(cur)}</textarea>
        <div class="sub" style="margin-top:6px;">â€»ç©ºã«ã™ã‚‹ã¨å‰Šé™¤</div>
      </div>
    `;

    acts.innerHTML="";
    const btnCancel=document.createElement("button");
    btnCancel.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
    btnCancel.className="btn-muted";
    btnCancel.addEventListener("click", closeModal);

    const btnSave=document.createElement("button");
    btnSave.textContent="ä¿å­˜";
    btnSave.addEventListener("click",()=>{
      const v = (safeEl("tmpMemoDay")?.value||"").trim();
      if(!state.memos) state.memos = {};
      if(v) state.memos[dayKey]=v; else delete state.memos[dayKey];
      saveState(); updateUI();
      closeModal();
    });

    acts.appendChild(btnCancel);
    acts.appendChild(btnSave);

    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");
  }

  // Online duration input via dropdowns (HH + MM).
  const ov = safeEl("modalOverlay");
  const ttl = safeEl("modalTitle");
  const mm  = safeEl("modalMsg");
  const acts= safeEl("modalActions");
  if(!ov||!ttl||!mm||!acts) return;

  ttl.textContent = dayKey ? `${fmtDayKey(dayKey)} ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“` : "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“ã‚’å…¥åŠ›";
  dayBoundaryResetIfNeeded();

  const baseMs = (dayKey && dayKey!==todayKey()) ? onlineMsForDay(dayKey) : currentOnlineMs();
  const curMin = Math.floor((baseMs||0)/60000);
  const curH = Math.min(24, Math.floor(curMin/60));
  const curM = Math.min(59, curMin%60);

  const hourOpts = Array.from({length:25},(_,i)=>`<option value="${i}" ${i===curH?'selected':''}>${i}æ™‚é–“</option>`).join("");
  const minOpts = Array.from({length:61},(_,i)=>{
    const label = (i===60) ? "60åˆ†" : `${i}åˆ†`;
    const sel = (i===curM) ? 'selected' : '';
    return `<option value="${i}" ${sel}>${label}</option>`;
  }).join("");

  mm.innerHTML = `
    <div style="font-size:12px;color:rgba(226,232,240,.85);margin-bottom:8px;line-height:1.4;">
      ä»Šæ—¥ï¼ˆ4æ™‚ã€œï¼‰ã® <strong>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“ãã®ã‚‚ã®</strong> ã‚’é¸æŠã—ã¦ã­ï¼ˆ1åˆ†åˆ»ã¿ï¼‰
    </div>
    <div class="row" style="gap:8px;">
      <div>
        <div class="label">æ™‚é–“</div>
        <select id="tmpDurH">${hourOpts}</select>
      </div>
      <div>
        <div class="label">åˆ†</div>
        <select id="tmpDurM">${minOpts}</select>
      </div>
    </div>
  `;

  acts.innerHTML="";
  const btnCancel=document.createElement("button");
  btnCancel.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
  btnCancel.className="btn-muted";
  btnCancel.addEventListener("click",()=>{
    ov.classList.remove("show");
    ov.setAttribute("aria-hidden","true");
  });

  const btnSave=document.createElement("button");
  btnSave.textContent="åæ˜ ";
  btnSave.addEventListener("click",()=>{
    const hh = toInt(safeEl("tmpDurH")?.value);
    const mmv = toInt(safeEl("tmpDurM")?.value);

    let totalMin = (hh*60) + mmv;
    if(mmv===60) totalMin = (Math.min(24, hh+1)*60); // 60åˆ†ã¯ç¹°ã‚Šä¸Šã’
    totalMin = Math.max(0, Math.min(24*60, totalMin));

    const durMs = totalMin * 60000;

    if(dayKey && dayKey!==todayKey()){
      if(!state.onlineByDay) state.onlineByDay = {};
      state.onlineByDay[dayKey] = durMs;
    }else{
      state.online.isOn = false;
      state.online.startAt = 0;
      state.online.accumulatedMs = durMs;
      state.online.lastKey = todayKey();
      if(!state.onlineByDay) state.onlineByDay = {};
      state.onlineByDay[todayKey()] = durMs;
    }

    ov.classList.remove("show");
    ov.setAttribute("aria-hidden","true");
    showToast("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“ã‚’åæ˜ ã—ãŸ");
    updateUI();
  });

  acts.appendChild(btnCancel);
  acts.appendChild(btnSave);

  ov.classList.add("show");
  ov.setAttribute("aria-hidden","false");
}
  // calendar
  let calendarOpen=!!state.calendarOpen;
  function setCalendarOpen(v){
    calendarOpen=!!v;
    const wrap=safeEl("calendarWrap");
    const btn=safeEl("calendarToggle");
    if(wrap) wrap.style.display=calendarOpen?"block":"none";
    if(btn) btn.textContent=calendarOpen?"é–‰ã˜ã‚‹":"è¡¨ç¤ºã™ã‚‹";
    if(calendarOpen) renderCalendar();
    saveState();
  }

  function renderCalendar(){
    const box=safeEl("calendarList"); if(!box) return;
    const days=[],now=Date.now();
    for(let i=0;i<31;i++){
      const key=businessDayKey(now-i*86400000);
      if(!days.includes(key)) days.push(key);
    }
    box.innerHTML=days.map(k=>{
      const t=totalsForDay(k);
      const onlineH = (onlineMsForDay(k)/3600000);
      const onlineW = onlineH>0 ? Math.floor(t.sales/onlineH) : 0;
      const workH = (t.workMs||0)/3600000;
      const workW = workH>0 ? Math.floor(t.sales/workH) : 0;
      const memo = (state.memos && state.memos[k]) ? state.memos[k] : "";
      return `<div class="calDay" data-day="${k}">
        <div class="calHead">
          <div class="calDate">${fmtDayKey(k)}</div>
          <div class="calMetrics">
            <span>ç·å£²ä¸Š: Â¥${fmtYen(t.sales)}</span>
            <span>é…é”ä»¶æ•°: ${fmtYen(t.count)}å›</span>
            <span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚çµ¦æ›ç®—: Â¥${fmtYen(onlineW)}/h</span>
            <span>ç¾é‡‘: Â¥${fmtYen(t.cashSum)}</span>
          </div>
        </div>
        <div class="calMemo">${memo ? "ãƒ¡ãƒ¢ï¼š"+escapeHtml(memo) : "ãƒ¡ãƒ¢ï¼šï¼ˆãªã—ï¼‰"}</div>
        <div class="calDetails">
          <div class="calBtnRow" style="display:flex;gap:8px;">
            <button type="button" class="calBtn" data-editday="1" style="flex:1;background:rgba(2,6,23,.18);border:1px solid rgba(148,163,184,.22);">ç·¨é›†</button>
            <button type="button" class="calBtn" data-openruns="1" style="flex:1;">é…é”ãƒ­ã‚°ï¼ˆã•ã‚‰ã«é–‹ãï¼‰</button>
          </div>
          <div class="calRuns"></div>
        </div>
      </div>`;
    }).join("");

    box.querySelectorAll(".calDay").forEach(dayEl=>{
      const head=dayEl.querySelector(".calHead");
      const btn=dayEl.querySelector('[data-openruns="1"]');
      const editBtn=dayEl.querySelector('[data-editday="1"]');
      const runsBox=dayEl.querySelector(".calRuns");
      const dayKey=dayEl.getAttribute("data-day");

      head.addEventListener("click",()=>dayEl.classList.toggle("open"));

      editBtn?.addEventListener("click",(ev)=>{ev.stopPropagation(); openDayEditor(dayKey);});

      btn.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        const open=dayEl.classList.toggle("showruns");
        if(open){
          const {start,end}=businessWindow(dayKey);
          const runs=state.runsLog.filter(r=>r.ts>=start&&r.ts<end).slice().reverse();
          if(!runs.length){
            runsBox.innerHTML=`<div class="sub" style="margin:6px 0 0;">ãã®æ—¥ã®é…é”ãƒ­ã‚°ãªã—</div>`;
          }else{
            runsBox.innerHTML=runs.map(r=>{
              const wage=r.minutes>0?Math.floor(r.amount/(r.minutes/60)):0;
              return `<div class="runitem" style="margin-top:8px;">
                <div><strong>Â¥${fmtYen(r.amount)}</strong> / ${r.minutes}åˆ† / ${r.count||1}ä»¶</div>
                <div class="small">æ™‚çµ¦æ›ç®—ï¼šÂ¥${fmtYen(wage)}/hã€€ç¾é‡‘ä»£å¼•ãï¼šÂ¥${fmtYen(r.cashCollected||0)}</div>
              </div>`;
            }).join("");
          }
          btn.textContent="é–‰ã˜ã‚‹";
        }else{
          btn.textContent="é…é”ãƒ­ã‚°ï¼ˆã•ã‚‰ã«é–‹ãï¼‰";
        }
      });
    });
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function updateUI(){
    dayBoundaryResetIfNeeded();

    const dayKey=todayKey();
    const t=totalsForDay(dayKey);

    // top sums
    if(safeEl("questSum")) safeEl("questSum").textContent=fmtYen(t.questSum);
    if(safeEl("cashSum")) safeEl("cashSum").textContent=fmtYen(t.cashSum);

    const gRuns=toInt(state.goal?.runs||0);
    const gAmt=toInt(state.goal?.amount||0);
    if(safeEl("targetRunsLabel")) safeEl("targetRunsLabel").textContent=gRuns>0?`${gRuns}å›`:"ãªã—";
    if(safeEl("targetAmountLabel")) safeEl("targetAmountLabel").textContent=gAmt>0?`Â¥${fmtYen(gAmt)}`:"ãªã—";

    if(safeEl("totalSales")) safeEl("totalSales").textContent=fmtYen(t.sales);
    if(safeEl("runCount")) safeEl("runCount").textContent=fmtYen(t.count);

    const onlineMs=currentOnlineMs();
    if(safeEl("onlineTime")) safeEl("onlineTime").textContent=fmtHHMM(onlineMs);
    if(safeEl("workTime")) safeEl("workTime").textContent=fmtHHMM(t.workMs);

    const onlineH=onlineMs/3600000, workH=(t.workMs||0)/3600000;
    if(safeEl("onlineWage")) safeEl("onlineWage").textContent=fmtYen(onlineH>0?Math.floor(t.sales/onlineH):0);
    if(safeEl("workWage")) safeEl("workWage").textContent=fmtYen(workH>0?Math.floor(t.sales/workH):0);

    // achievement
    let ach = 0;
    if(gAmt>0) ach = Math.floor((t.sales/gAmt)*100);
    else if(gRuns>0) ach = Math.floor((t.count/gRuns)*100);
    if(gAmt>0||gRuns>0){
      if(safeEl("achRow")) safeEl("achRow").style.display="flex";
      const bar = Math.min(100, Math.max(0, ach));
      if(safeEl("achFill")) safeEl("achFill").style.width=`${bar}%`;
      if(safeEl("achText")) safeEl("achText").textContent=`${Math.max(0, ach)}%`;
    }else{
      if(safeEl("achRow")) safeEl("achRow").style.display="none";
    }

    const met=(gAmt>0&&t.sales>=gAmt)||(gRuns>0&&t.count>=gRuns);
    const main=safeEl("mainStatsCard");
    if(main) main.classList.toggle("goal-met", met);

    // online indicator
    const badge=safeEl("onlineBadge");
    const o=state.online;
    if(badge) badge.style.display = o.isOn ? "inline" : "none";
    const stateEl=safeEl("onlineState");
    if(stateEl) stateEl.style.display = o.isOn ? "block" : "none";

    // runlist if open
    if(runListOpen) renderRunList();

    saveState();
  }
  function bind(){
    // buttons
    safeEl("btnReload")?.addEventListener("click", ()=>{ location.reload(); });
    safeEl("btnAddRun")?.addEventListener("click", addRun);
    safeEl("btnToggleRunList")?.addEventListener("click", ()=>{
      runListOpen=!runListOpen;
      const box=safeEl("runList");
      if(box) box.style.display = runListOpen ? "block" : "none";
      if(runListOpen) renderRunList();
    });

    safeEl("btnAddQuest")?.addEventListener("click", addQuest);
    safeEl("btnAddCashTip")?.addEventListener("click", addCashTip);
    safeEl("btnResetQuestToday")?.addEventListener("click", ()=>{
      showModal({
        title:"ç¢ºèª",
        msg:"ä»Šæ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼Ÿï¼ˆéå»æ—¥ã¯æ¶ˆãˆãªã„ï¼‰",
        buttons:[
          {text:"ã‚„ã‚ã‚‹", type:"muted", onClick:()=>{}},
          {text:"ãƒªã‚»ãƒƒãƒˆ", type:"danger", onClick:()=>resetQuestToday()}
        ]
      });
    });


    safeEl("btnResetAll")?.addEventListener("click", ()=>{
      showModal({
        title:"ç¢ºèª",
        msg:"å…¨ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼Ÿï¼ˆé…é”ãƒ­ã‚°ãƒ»ã‚¯ã‚¨ã‚¹ãƒˆãƒ»ç›®æ¨™ãƒ»ãƒ¡ãƒ¢ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“ãªã©å…¨éƒ¨æ¶ˆãˆã‚‹ï¼‰",
        buttons:[
          {text:"ã‚„ã‚ã‚‹", type:"muted", onClick:()=>{}},
          {text:"ãƒªã‚»ãƒƒãƒˆ", type:"danger", onClick:()=>{
            try{ localStorage.removeItem(STORE_KEY); }catch(e){}
            location.reload();
          }}
        ]
      });
    });    safeEl("btnGoalSet")?.addEventListener("click", setGoal);
    safeEl("btnGoalReset")?.addEventListener("click", ()=>{
      showModal({
        title:"ç¢ºèª",
        msg:"ç›®æ¨™ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼Ÿ",
        buttons:[
          {text:"ã‚„ã‚ã‚‹", type:"muted", onClick:()=>{}},
          {text:"ãƒªã‚»ãƒƒãƒˆ", type:"danger", onClick:()=>resetGoal()}
        ]
      });
    });

    safeEl("btnOnline")?.addEventListener("click", ()=>setOnline(true,"manual"));
    safeEl("btnOffline")?.addEventListener("click", ()=>confirmOffline());

    // calendar open
    safeEl("calendarTitle")?.addEventListener("click", ()=>setCalendarOpen(!calendarOpen));
    safeEl("calendarToggle")?.addEventListener("click", ()=>setCalendarOpen(!calendarOpen));
    setCalendarOpen(!!state.calendarOpen);

    // online time tap
    safeEl("onlineTimeBox")?.addEventListener("click", openOnlineTimeEditor);

    // delivery complete popup: tap to close
    const dcOv = safeEl("dcOverlay");
    if(dcOv){
      dcOv.addEventListener("click", closeDeliveryCompletePopup);
    }

    // memo per day
    const memoBox=safeEl("inputMemo");
    if(memoBox){
      const k=todayKey();
      memoBox.value = (state.memos && state.memos[k]) ? state.memos[k] : "";
      memoBox.addEventListener("input", ()=>{
        const kk=todayKey();
        state.memos = state.memos || {};
        state.memos[kk] = memoBox.value || "";
        markDirty();
        saveState();
      });
    }

    // quick memos
    safeEl("btnQmAdd")?.addEventListener("click", ()=>{ qmEditingId=null; qmOpen(null); });
    safeEl("qmSearch")?.addEventListener("input", qmRender);
    safeEl("qmSearch")?.addEventListener("focus", qmRender);
    safeEl("qmSearch")?.addEventListener("blur", ()=>{ qmUpdateVisibility(); });
    safeEl("btnQmCancel")?.addEventListener("click", qmClose);
    safeEl("btnQmSave")?.addEventListener("click", qmSave);
    safeEl("btnFlagNone")?.addEventListener("click", ()=>qmSetFlag("none"));
    safeEl("btnFlagYellow")?.addEventListener("click", ()=>qmSetFlag("yellow"));
    safeEl("btnFlagRed")?.addEventListener("click", ()=>qmSetFlag("red"));
    safeEl("btnQmDelete")?.addEventListener("click", qmDelete);
    safeEl("btnQmExport")?.addEventListener("click", qmExport);
    safeEl("btnQmImport")?.addEventListener("click", ()=> safeEl("qmImportFile")?.click());
    safeEl("qmImportFile")?.addEventListener("change", (e)=>{
      const f = e.target && e.target.files ? e.target.files[0] : null;
      if(f) qmImportFromFile(f);
      e.target.value = "";
    });
    safeEl("qmOverlay")?.addEventListener("click", (e)=>{
      if(e.target && e.target.id==="qmOverlay") qmClose();
    });
    // initial state
    qmUpdateVisibility();

  
    // long-press on count to open maintenance
    const cntEl = safeEl("qmCount");
    if(cntEl){
      let lpTimer=null;
      const startLP=()=>{
        clearTimeout(lpTimer);
        lpTimer=setTimeout(()=>{ qmMaintOpen(); }, 700);
      };
      const cancelLP=()=>{ clearTimeout(lpTimer); lpTimer=null; };
      cntEl.addEventListener("touchstart", startLP, {passive:true});
      cntEl.addEventListener("touchend", cancelLP);
      cntEl.addEventListener("touchmove", cancelLP);
      cntEl.addEventListener("mousedown", startLP);
      cntEl.addEventListener("mouseup", cancelLP);
      cntEl.addEventListener("mouseleave", cancelLP);
    }

    // maintenance overlay buttons
    safeEl("btnQmMaintClose")?.addEventListener("click", qmMaintClose);
    safeEl("btnQmMaintExport")?.addEventListener("click", ()=>{ qmMaintClose(); qmExport(); });
    safeEl("btnQmMaintImport")?.addEventListener("click", ()=>{ qmMaintClose(); safeEl("qmImportFile")?.click(); });
    safeEl("btnQmResetAllMemos")?.addEventListener("click", qmResetAllMemos);
    safeEl("qmMaintOverlay")?.addEventListener("click", (e)=>{
      if(e.target && e.target.id==="qmMaintOverlay") qmMaintClose();
    });

}

  
  // ===== Quick Memos (ç«¯æœ«å†…ãƒ¡ãƒ¢) =====
  let qmEditingId = null;

  function qmSetFlag(flag){
    const f=(flag||"none");
    const hid=safeEl("qmFlag"); if(hid) hid.value=f;
    const bN=safeEl("btnFlagNone"), bY=safeEl("btnFlagYellow"), bR=safeEl("btnFlagRed");
    [bN,bY,bR].forEach(b=>{ if(b) b.classList.remove("active"); });
    if(f==="yellow" && bY) bY.classList.add("active");
    else if(f==="red" && bR) bR.classList.add("active");
    else if(bN) bN.classList.add("active");
  }


  function qmEnsureArray(){
    if(!state.quickMemos || !Array.isArray(state.quickMemos)) state.quickMemos = [];
    // migrate
    try{
      state.quickMemos.forEach(it=>{
        if(!it) return;
        if(!it.id) it.id = "qm_" + qmNow() + "_" + Math.random().toString(16).slice(2);
        if(!("flag" in it)) it.flag = "none";
      });
    }catch(e){}
    return state.quickMemos;
  }
  function qmNow(){ return Date.now(); }
  function qmFmt(ts){
    try{
      const d=new Date(ts);
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const day=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0");
      const mm=String(d.getMinutes()).padStart(2,"0");
      return `${y}/${m}/${day} ${hh}:${mm}`;
    }catch(e){ return ""; }
  }
  function qmEscape(s){
    return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }
  function qmEscRe(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  function qmHighlight(text, q){
    const t=String(text||"");
    const qq=String(q||"").trim();
    if(!qq) return qmEscape(t);
    try{
      const re=new RegExp(qmEscRe(qq),"gi");
      return qmEscape(t).replace(re, (m)=>`<mark>${qmEscape(m)}</mark>`);
    }catch(e){
      return qmEscape(t);
    }
  }
  function qmSnippet(body){
    const s=String(body||"").replace(/\s+/g," ").trim();
    return s;
  }

  
  function qmUpdateVisibility(){
    const wrap=safeEl("qmResultsWrap");
    const box=safeEl("qmSearch");
    const cnt=safeEl("qmCount");
    // count
    try{
      const total = qmEnsureArray().length;
      if(cnt) cnt.textContent = `ç™»éŒ²ä»¶æ•°ï¼š${total}ä»¶`;
    }catch(e){}

    if(!wrap || !box) return;
    const q=(box.value||"").trim();
    const focused = (document.activeElement===box);

    // æœªå…¥åŠ›ï¼†éãƒ•ã‚©ãƒ¼ã‚«ã‚¹ â†’ ä»¶æ•°ã ã‘è¡¨ç¤ºã€çµæœæ¬„ã¯éš ã™
    if(!q && !focused){
      wrap.style.display="none";
      if(cnt) cnt.style.display="block";
      return;
    }

    // å…¥åŠ›ã‚ã‚Š or ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ â†’ çµæœæ¬„ã‚’è¡¨ç¤ºï¼ˆãŸã ã—æœªå…¥åŠ›ãªã‚‰ä¸­ã¯ã‚¬ã‚¤ãƒ‰ã ã‘ï¼‰
    wrap.style.display="block";
    if(cnt) cnt.style.display="none";

    const lab=safeEl("qmResultsLabel");
    if(lab) lab.textContent = q ? `æ¤œç´¢çµæœï¼ˆ${q}ï¼‰` : "æ¤œç´¢ï¼ˆå…¥åŠ›ã™ã‚‹ã¨çµæœãŒå‡ºã¾ã™ï¼‰";
  }

  function qmRender(){
    qmUpdateVisibility();
    const wrap=safeEl("qmResultsWrap");
    // éè¡¨ç¤ºä¸­ã¯DOMæ›´æ–°ã—ãªã„ï¼ˆè»½é‡åŒ–ï¼‰
    if(wrap && wrap.style.display==="none") return;

    const list=safeEl("qmList");
    if(!list) return;

    const box=safeEl("qmSearch");
    const q=(box?.value || "").trim();

    // æœªå…¥åŠ›æ™‚ã¯ä¸€è¦§ã‚’å‡ºã•ãªã„ï¼ˆ200ä»¶ã§ã‚‚ç”»é¢ãŒåŸ‹ã¾ã‚‰ãªã„ï¼‰
    if(!q){
      list.innerHTML = `<div class="subtitle" style="text-align:center; padding:10px;">æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>`;
      return;
    }

    const arr=qmEnsureArray().slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
    const filtered = arr.filter(it=>{
      const hay = (it.title||"") + "\n" + (it.body||"");
      return hay.includes(q);
    });

    // è¿”ã—ã™ãã‚‹ã¨é‡ã„ã®ã§ä¸Šé™
    const LIMIT = 120;
    const limited = filtered.slice(0, LIMIT);

    if(!limited.length){
      list.innerHTML = `<div class="subtitle" style="text-align:center; padding:10px;">ï¼ˆãƒ’ãƒƒãƒˆãªã—ï¼‰</div>`;
      return;
    }

    list.innerHTML = limited.map(it=>{
      const title = it.title ? qmHighlight(it.title, q) : "ï¼ˆç„¡é¡Œï¼‰";
      const body = it.body || "";
      const snippetRaw = body.length>220 ? (body.slice(0,220) + "â€¦") : body;
      const snippet = qmHighlight(snippetRaw, q);
      const meta = qmFmt(it.updatedAt||it.createdAt||0);

      const f = (it.flag||"none");
      const flagClass = (f==="yellow") ? "flag-yellow" : (f==="red") ? "flag-red" : "";
      const badge = (f==="yellow") ? `<span class="qm-flagbadge yellow">é»„</span>` : (f==="red") ? `<span class="qm-flagbadge red">èµ¤</span>` : ``;

      return `
        <div class="qm-item ${flagClass}" data-qmid="${qmEscape(it.id)}">
          <div class="qm-top">
            <div class="qm-title">${title}${badge}</div>
            <div class="qm-meta">${qmEscape(meta)}</div>
          </div>
          <div class="qm-snippet">${snippet}</div>
        </div>
      `;
    }).join("");

    // bind item clicks
    list.querySelectorAll(".qm-item").forEach(el=>{
      el.addEventListener("click", ()=>{
        const id=el.getAttribute("data-qmid");
        qmOpen(id);
      });
    });
  }

  function qmOpen(id){
    const ov=safeEl("qmOverlay");
    if(!ov) return;
    const arr=qmEnsureArray();
    const it = arr.find(x=>x.id===id) || null;
    qmEditingId = it ? it.id : null;

    const titleBox=safeEl("qmTitle");
    const bodyBox=safeEl("qmBody");
    const delBtn=safeEl("btnQmDelete");
    const modalTitle=safeEl("qmModalTitle");

    if(titleBox) titleBox.value = it ? (it.title||"") : "";
    if(bodyBox) bodyBox.value = it ? (it.body||"") : "";
    qmSetFlag(it ? (it.flag||"none") : "none");

    if(delBtn) delBtn.style.display = it ? "inline-block" : "none";
    if(modalTitle) modalTitle.textContent = it ? "ãƒ¡ãƒ¢ç·¨é›†" : "ãƒ¡ãƒ¢è¿½åŠ ";

    ov.style.display="flex";
    ov.setAttribute("aria-hidden","false");
  }

  function qmClose(){
    const ov=safeEl("qmOverlay");
    if(!ov) return;
    ov.style.display="none";
    ov.setAttribute("aria-hidden","true");
    qmEditingId = null;
  }

  function qmMaintOpen(){
    const ov=safeEl("qmMaintOverlay");
    if(!ov) return;
    ov.style.display="flex";
    ov.setAttribute("aria-hidden","false");
  }
  function qmMaintClose(){
    const ov=safeEl("qmMaintOverlay");
    if(!ov) return;
    ov.style.display="none";
    ov.setAttribute("aria-hidden","true");
  }
  function qmResetAllMemos(){
    // 2æ®µéšç¢ºèªï¼ˆèª¤æ“ä½œé˜²æ­¢ï¼‰
    const ok1 = confirm("ä¿å­˜ã—ã¦ã„ã‚‹ãƒ¡ãƒ¢ã‚’å…¨ä»¶å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if(!ok1) return;
    const ok2 = confirm("æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚");
    if(!ok2) return;

    state.quickMemos = [];
    markDirty(); saveState();
    // UIæ›´æ–°
    const box=safeEl("qmSearch"); if(box) box.value="";
    qmUpdateVisibility();
    qmRender();
    showToast("å…¨ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    qmMaintClose();
  }


  function qmSave(){
    const title=(safeEl("qmTitle")?.value || "").trim();
    const body=(safeEl("qmBody")?.value || "").trim();
    const flag=(safeEl("qmFlag")?.value || "none").trim();
    if(!body && !title){
      showToast("ç©ºãªã®ã§ä¿å­˜ã—ã¾ã›ã‚“");
      return;
    }
    const arr=qmEnsureArray();
    const now=qmNow();
    if(qmEditingId){
      const it=arr.find(x=>x.id===qmEditingId);
      if(it){
        it.title=title;
        it.body=body;
        it.flag=flag;
        it.updatedAt=now;
      }
      showToast("ä¿å­˜ã—ã¾ã—ãŸ");
    }else{
      const id = "qm_" + now + "_" + Math.random().toString(16).slice(2);
      arr.push({id, title, body, flag, createdAt: now, updatedAt: now});
      showToast("è¿½åŠ ã—ã¾ã—ãŸ");
    }
    markDirty();
    saveState(true);
    qmRender();
    qmClose();
  }

  function qmDelete(){
    if(!qmEditingId) return;
    const arr=qmEnsureArray();
    const idx=arr.findIndex(x=>x.id===qmEditingId);
    if(idx>=0) arr.splice(idx,1);
    markDirty();
    saveState(true);
    showToast("å‰Šé™¤ã—ã¾ã—ãŸ");
    qmRender();
    qmClose();
  }

  function qmExport(){
    const payload = {
      type: "delizult_backup",
      version: APP_VERSION,
      exportedAt: new Date().toISOString(),
      state
    };
    const blob=new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a=document.createElement("a");
    const ymd = todayKey().replace(/-/g,"");
    a.download = `delizult_backup_${ymd}.json`;
    a.href = URL.createObjectURL(blob);
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
  }

  function qmImportFromFile(file){
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const obj=JSON.parse(String(reader.result||""));
        const st = obj && obj.state ? obj.state : null;
        if(!st || typeof st!=="object"){
          showToast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼ˆå½¢å¼ãŒé•ã†ï¼‰");
          return;
        }
        // merge onto defaultState to avoid missing keys
        const base = structuredClonePoly(defaultState);
        const merged = Object.assign(base, st);
        merged.goal = Object.assign(structuredClonePoly(defaultState.goal), st.goal||{});
        merged.online = Object.assign(structuredClonePoly(defaultState.online), st.online||{});
        if(!Array.isArray(merged.quickMemos)) merged.quickMemos = [];
        state = merged;
        markDirty();
        saveState(true);
        showToast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†");
        updateUI();
        qmRender();
      }catch(e){
        showToast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼ˆJSONèª­ã‚ãªã„ï¼‰");
      }
    };
    reader.readAsText(file);
  }

  function qmApplyQueryFromURL(opts){
    const o=opts||{};
    const triesMax = o.triesMax ?? 12;
    const delayMs = o.delayMs ?? 60;

    let q=null, url=null;
    try{
      url = new URL(window.location.href);
      q = url.searchParams.get("q");
    }catch(e){ return; }
    if(!q) return;

    const attempt = (o.attempt ?? 0);

    const box=safeEl("qmSearch");
    // DOMãŒã¾ã æº–å‚™ã§ãã¦ãªã„æ™‚ã¯å°‘ã—å¾…ã£ã¦å†ãƒˆãƒ©ã‚¤ï¼ˆSafariå¯¾ç­–ï¼‰
    if(!box){
      if(attempt < triesMax){
        setTimeout(()=>qmApplyQueryFromURL({triesMax, delayMs, attempt: attempt+1}), delayMs);
      }
      return;
    }

    // ã“ã“ã¾ã§æ¥ãŸã‚‰ç¢ºå®Ÿã«åæ˜ 
    box.value = q;
    qmRender();

    // qã‚’URLã‹ã‚‰æ¶ˆã™ï¼ˆå±¥æ­´å¯¾ç­–ï¼‰
    try{
      url.searchParams.delete("q");
      history.replaceState(null, "", url.toString());
    }catch(e){}

    // ãƒ¡ãƒ¢ã‚«ãƒ¼ãƒ‰ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    try{
      const card=safeEl("quickMemoCard");
      if(card && card.scrollIntoView) card.scrollIntoView({behavior:"smooth", block:"start"});
    }catch(e){}
  }

function init(){
    // initialize day key
    state.online.lastKey = state.online.lastKey || todayKey();
    dayBoundaryResetIfNeeded();

    // initialize online buttons styles
    const o=state.online;
    const bOn=safeEl("btnOnline"), bOff=safeEl("btnOffline");
    if(bOn && bOff){
      if(o.isOn){
        bOn.classList.remove("btn-muted");
        bOff.classList.add("btn-muted");
      }else{
        bOn.classList.add("btn-muted");
        bOff.classList.remove("btn-muted");
      }
    }
    bind();
    const fv=safeEl("footerVer"); if(fv) fv.textContent = APP_VERSION;
    updateUI();
    qmRender();
    qmApplyQueryFromURL();
    setTimeout(()=>qmApplyQueryFromURL(), 80);
    setInterval(updateUI, 1000);
  }

  document.addEventListener("DOMContentLoaded", init);

  // When Safari restores from back/forward cache or reuses an existing tab,
  // the page may not fully reload. Re-apply query on these lifecycle events.
  window.addEventListener("pageshow", () => { qmApplyQueryFromURL(); setTimeout(()=>qmApplyQueryFromURL(), 80); });
  window.addEventListener("popstate", () => { qmApplyQueryFromURL(); setTimeout(()=>qmApplyQueryFromURL(), 80); });
  window.addEventListener("hashchange", () => { qmApplyQueryFromURL(); setTimeout(()=>qmApplyQueryFromURL(), 80); });
  document.addEventListener("visibilitychange", () => {
    if(!document.hidden){ qmApplyQueryFromURL(); setTimeout(()=>qmApplyQueryFromURL(), 80); }
  });


})();

</script>


</body></html>