<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>配達ドリルトラッカー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --card: #141a2b;
      --accent: #3ba9ff;
      --accent-soft: #234567;
      --gold: #ffd700;
      --text: #f5f5f5;
      --muted: #9ca3af;
      --danger: #f97373;

      --ok: #22c55e;
      --cyan: #06b6d4;
      --orange: #f97316;
      --yellow: #facc15;
      --red: #ef4444;
      --slate: #334155;
      --slate2: #0f172a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #182848 0, #050816 55%, #02030a 100%);
      color: var(--text);
    }

    h1 { font-size: 20px; margin: 0 0 4px; }
    .sub { font-size: 11px; color: var(--muted); margin-bottom: 10px; }

    .card {
      background: linear-gradient(135deg, rgba(20,26,43,0.95), rgba(9,12,24,0.98));
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 18px 35px rgba(0,0,0,0.8);
      border: 1px solid rgba(59,169,255,0.1);
      backdrop-filter: blur(10px);
      margin-bottom: 10px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-bottom: 10px;
    }
    .dash-item {
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.2);
      min-height: 54px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .dash-label { font-size: 10px; color: var(--muted); }
    .dash-value { font-size: 16px; font-weight: 650; }

    .top-stack {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .top-row {
      padding: 10px 10px;
      border-radius: 12px;
      background: radial-gradient(circle at top, #3b82f6 0, #020617 55%);
      border: 1px solid rgba(59,130,246,0.5);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .top-row .label { font-size: 12px; color: #e5e7eb; text-align: center; }
    .top-row .value {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: 0.2px;
      margin-top: 2px;
      display: inline-block;
    }
    .value.tier-0 { color: #f5f5f5; }
    .value.tier-1 { color: #f8fafc; text-shadow: 0 1px 0 rgba(255,255,255,0.10); font-weight: 820; }
    .value.tier-2 { color: #fde68a; }
    .value.tier-3 { color: #facc15; }
    .value.tier-4 {
      color: var(--gold);
      text-shadow:
        0 0 8px rgba(255,215,0,0.25),
        0 0 16px rgba(255,215,0,0.22);
    }

    /* キラキラ（素材なし） */
    .sparkle::before, .sparkle::after {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle, rgba(255,255,255,0.20) 0 2px, transparent 3px) 0 0 / 80px 80px,
        radial-gradient(circle, rgba(255,215,0,0.18) 0 2px, transparent 3px) 40px 20px / 90px 90px;
      transform: rotate(12deg);
      animation: sparkleMove 3.2s linear infinite;
      pointer-events: none;
      opacity: 0.75;
    }
    .sparkle::after {
      animation-duration: 4.6s;
      opacity: 0.45;
      transform: rotate(-8deg);
    }
    @keyframes sparkleMove {
      from { transform: translate3d(-8%, -6%, 0) rotate(10deg); }
      to   { transform: translate3d( 8%,  6%, 0) rotate(10deg); }
    }

    .goal-met {
      border-color: rgba(250,204,21,0.75) !important;
      box-shadow: 0 18px 35px rgba(250,204,21,0.10), 0 0 18px rgba(250,204,21,0.12) inset;
    }

    .mid-row {
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.22);
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .mid-row .k { font-size: 12px; color: var(--muted); }
    .mid-row .v { font-size: 18px; font-weight: 750; }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      align-items: stretch;
    }
    .row > div { flex: 1; }

    input[type="text"], select, textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 12px;
      outline: none;
    }
    input::placeholder { color: #6b7280; }

    /* iPhoneの入力ズーム対策：focus中だけ16px（viewport禁止は使わない） */
    input[type="text"]:focus, textarea:focus, select:focus { font-size: 16px; }

    .label { font-size: 11px; color: var(--muted); margin-bottom: 2px; }

    button {
      width: 100%;
      padding: 8px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, var(--ok), var(--cyan));
      color: white;
      font-weight: 700;
      font-size: 13px;
      box-shadow: 0 8px 18px rgba(16,185,129,0.55);
      cursor: pointer;
      margin-top: 4px;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(16,185,129,0.45);
    }

    .btn-row { display: flex; gap: 8px; margin-top: 4px; }
    .btn-row button { width: 100%; font-size: 12px; padding: 7px; margin-top: 0; }

    .btn-quest {
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      box-shadow: 0 8px 18px rgba(59,130,246,0.55);
    }
    .btn-cash {
      background: linear-gradient(90deg, #f97316, #facc15);
      box-shadow: 0 8px 18px rgba(249,115,22,0.55);
    }
    .btn-goal {
      background: linear-gradient(90deg, #a855f7, #3b82f6);
      box-shadow: 0 8px 18px rgba(168,85,247,0.38);
    }
    .btn-muted {
      background: linear-gradient(90deg, #64748b, #334155);
      box-shadow: 0 8px 18px rgba(100,116,139,0.35);
    }
    .btn-danger {
      background: linear-gradient(90deg, #ef4444, #f97316);
      box-shadow: 0 8px 18px rgba(239,68,68,0.4);
    }

    .center-title {
      text-align: center;
      font-weight: 900;
      font-size: 20px;
      letter-spacing: 0.6px;
      margin: 2px 0 8px;
    }

    /* オンライン/オフライン切替（見た目は軽め） */
    .toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(2,6,23,0.35);
      border: 1px solid rgba(148,163,184,0.22);
      margin-top: 6px;
    }
    .toggle .tlabel { font-size: 12px; color: var(--muted); }
    .seg {
      display: flex;
      gap: 6px;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.22);
      border-radius: 999px;
      padding: 4px;
    }
    .seg button {
      margin: 0;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 999px;
      box-shadow: none;
      background: transparent;
      color: #cbd5e1;
      border: 1px solid transparent;
    }
    .seg button.active {
      background: linear-gradient(90deg, #22c55e, #06b6d4);
      color: #ffffff;
      border-color: rgba(255,255,255,0.15);
    }

    /* 配達済みリスト */
    .runlist{
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      margin-top: 0;
      padding: 0 8px;
      border: 1px solid rgba(148,163,184,0.0);
      border-radius: 12px;
      background: rgba(2,6,23,0.35);
      transition: max-height .22s ease, opacity .18s ease, margin-top .18s ease, border-color .18s ease, padding .18s ease;
      will-change: max-height, opacity;
    }
    .runlist.open{
      max-height: 1400px;
      opacity: 1;
      margin-top: 8px;
      padding: 8px;
      border-color: rgba(148,163,184,0.22);
    }

    .run-item {
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 8px;
      background: rgba(15,23,42,0.65);
    }
    .run-item:last-child { margin-bottom: 0; }

    .run-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    .run-head .left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .run-head .stamp { font-size: 11px; color: #cbd5e1; }
    .run-head .mini { font-size: 10px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .run-head .caret {
      font-size: 14px;
      color: #cbd5e1;
      opacity: 0.9;
      flex: 0 0 auto;
    }

    .run-body {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height .18s ease, opacity .18s ease, margin-top .18s ease;
      margin-top: 0;
    }
    .run-item.open {
      background: rgba(59,130,246,0.12);
      border-color: rgba(59,130,246,0.38);
    }
    .run-item.open .run-body {
      max-height: 520px;
      opacity: 1;
      margin-top: 8px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 6px;
    }
    .actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .actions button {
      margin-top: 0;
      padding: 7px;
      font-size: 12px;
    }

    /* トースト */
    .toast {
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 14px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.78);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      font-size: 13px;
      z-index: 99998;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events: none;
      white-space: pre-wrap;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* デバッグ（エラー時のみ表示） */
    #debugBox {
      display: none;
      position:fixed;
      left:8px;
      right:8px;
      bottom:8px;
      max-height:40vh;
      overflow:auto;
      padding:10px;
      border-radius:12px;
      background:rgba(0,0,0,0.75);
      color:#fff;
      font-size:12px;
      z-index:99999;
      white-space:pre-wrap;
    }
    #debugBox.show { display:block; }
  
    /* ===== v11 additions ===== */
    .triple-row{ display:flex; gap:10px; margin-top:10px; }
    .triple-row .tri{ flex:1; padding:10px 10px; border-radius:12px; background: rgba(2,6,23,0.28); border:1px solid rgba(148,163,184,0.20); min-width:0; }
    .triple-row .k{ font-size:12px; color: rgba(226,232,240,0.85); }
    .triple-row .v{ font-size:18px; font-weight:900; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .clickable{ cursor:pointer; }
    .pill{ display:inline-block; margin-left:6px; padding:2px 7px; border-radius:999px; font-size:11px; font-weight:900; background: rgba(34,197,94,0.18); border:1px solid rgba(34,197,94,0.35); color: rgba(187,247,208,0.95); vertical-align:middle; }

    .double-row{ display:flex; gap:10px; margin-top:10px; }
    .double-row .dbl{ flex:1; padding:10px 10px; border-radius:12px; background: rgba(2,6,23,0.22); border:1px solid rgba(148,163,184,0.18); min-width:0; }
    .double-row .k{ font-size:12px; color: rgba(226,232,240,0.85); }
    .double-row .v{ font-size:16px; font-weight:900; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .ach-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; padding:10px 10px; border-radius:12px; background: rgba(2,6,23,0.18); border:1px solid rgba(148,163,184,0.16); }
    .ach-row .k{ font-size:12px; color: rgba(226,232,240,0.85); }
    .ach-right{ flex:1; display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .ach-pct{ font-weight:900; min-width:52px; text-align:right; }
    .ach-bar{ flex:1; height:10px; border-radius:999px; background: rgba(148,163,184,0.18); overflow:hidden; max-width:240px; border:1px solid rgba(148,163,184,0.18); }
    .ach-fill{ height:100%; border-radius:999px; background: linear-gradient(90deg, rgba(34,197,94,0.9), rgba(249,115,22,0.9)); }

    .big-input{ font-size:20px !important; font-weight:900; padding:12px 12px !important; }

    /* トースト強化 */
    .toast{ width: calc(100% - 24px); left: 12px; bottom: 12px; border: 1px solid rgba(148,163,184,0.30); background: rgba(2,6,23,0.92); padding: 14px 14px; min-height: 30vh; max-height: 30vh; overflow: auto; font-size: 14px; line-height: 1.35; }

    /* カレンダー */
    .cal-list{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .cal-day{ border-radius:12px; padding:10px 10px; background: rgba(2,6,23,0.20); border:1px solid rgba(148,163,184,0.18); }
    .cal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; cursor:pointer; }
    .cal-date{ font-weight:900; }
    .cal-metrics{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; text-align:right; }
    .cal-metrics span{ font-size:12px; color: rgba(226,232,240,0.88); }
    .cal-details{ margin-top:10px; display:none; }
    .cal-day.open .cal-details{ display:block; }
    .cal-btn{ margin-top:8px; width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,0.22); background: rgba(15,23,42,0.6); font-weight:900; }
    .cal-runs{ margin-top:8px; display:none; }
    .cal-day.showruns .cal-runs{ display:block; }

</style>
</head>

<body>
  <h1>配達ドリルトラッカー</h1>
  <div class="sub">午前4時で日付が切り替わる（Uberの締めに合わせる）。金額・時間・件数は手打ち。</div>

  <!-- 上部：4メニュー -->
  <div class="card">
    <div class="dashboard-grid">
      <div class="dash-item">
        <div class="dash-label">クエスト合計</div>
        <div class="dash-value">¥<span id="questTotalTop">0</span></div>
      </div>
      <div class="dash-item">
        <div class="dash-label">現金回収合計</div>
        <div class="dash-value">¥<span id="cashTotalTop">0</span></div>
      </div>
      <div class="dash-item">
        <div class="dash-label">目標回数</div>
        <div class="dash-value"><span id="targetRunsTop">なし</span></div>
      </div>
      <div class="dash-item">
        <div class="dash-label">目標金額</div>
        <div class="dash-value"><span id="targetAmountTop">なし</span></div>
      </div>
    </div>

    <!-- 目標入力 -->
    <div class="row" style="margin-top:2px;">
      <div>
        <div class="label">目標回数（任意）</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputTargetRuns" placeholder="未設定でもOK" />
      </div>
      <div>
        <div class="label">目標金額（任意・円）</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputTargetAmount" placeholder="未設定でもOK" />
      </div>
    </div>
    <div class="btn-row">
      <button class="btn-muted" onclick="clearGoals()">目標リセット</button>
      <button class="btn-goal" onclick="setGoals()">目標設定</button>
    </div>
  </div>

  <!-- 上部：総売上/配達回数/オンライン時給 -->
  <div class="card" id="topSummaryCard">
    <div class="top-stack">
      <div id="totalRow" class="top-row">
        <div class="label" id="totalLabel">総売上 (クエスト込み)</div>
        <div class="value tier-0" id="totalAmount">¥0</div>
      </div>

      <div class="mid-row" id="prevRow" style="display:none;">
        <div class="k">前日売上</div>
        <div class="v" id="prevSummary">¥0 / 0回</div>
      </div>

      <div class="ach-row" id="achRow" style="display:none;">
        <div class="k">達成率</div>
        <div class="ach-right">
          <div class="ach-pct" id="achPct">0%</div>
          <div class="ach-bar"><div class="ach-fill" id="achFill" style="width:0%;"></div></div>
        </div>
      </div>

      <div class="triple-row" id="tripleRow">
        <div class="tri">
          <div class="k">配達回数</div>
          <div class="v" id="runsSummary">0回</div>
        </div>
        <div class="tri clickable" id="onlineTimeBox" onclick="toggleOnlineTracking()">
          <div class="k">オンライン時間 <span class="pill" id="onlinePill" style="display:none;">ONLINE</span></div>
          <div class="v" id="onlineTime">00:00</div>
        </div>
        <div class="tri">
          <div class="k">実働時間</div>
          <div class="v" id="activeTime">00:00</div>
        </div>
      </div>

      <div class="double-row" id="hourlyRow">
        <div class="dbl">
          <div class="k">オンライン時給換算</div>
          <div class="v" id="onlineHourly">¥0/h</div>
        </div>
        <div class="dbl">
          <div class="k">実働時給換算</div>
          <div class="v" id="activeHourly">¥0/h</div>
        </div>
      </div>
    </div>
  </div>
    <div class="label" style="margin-top:2px;">日別：総売上 / 件数 / オンライン時給 / 実働時給</div>
    <div id="calendarList" class="cal-list"></div>
  </div>

  <!-- 配達案件（入力1本化） -->
  <div class="card">
    <div class="center-title">配達案件</div>

    <div class="row" style="margin-top:6px;">
      <div>
        <div class="label">時間 (分)</div>
        <input class="big-input" type="text" inputmode="numeric" pattern="[0-9]*" id="inputTime" placeholder="例: 28" />
      </div>
      <div>
        <div class="label">金額 (円)</div>
        <input class="big-input" type="text" inputmode="numeric" pattern="[0-9]*" id="inputAmount" placeholder="例: 1320" />
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">現金回収 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCash" placeholder="例: 300" />
      </div>
      <div>
        <div class="label">件数 (件)</div>
        <select id="inputCount">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">走行距離（任意・km）</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputDistance" placeholder="未入力でもOK" />
      </div>
      <div>
        <div class="label">　</div>
        <div class="toggle">
          <div class="tlabel">稼働</div>
          <div class="seg" role="group" aria-label="online toggle">
            <button type="button" id="btnOnline" class="active">オンライン</button>
            <button type="button" id="btnOffline">オフライン</button>
          </div>
        </div>
      </div>
    </div>

    <div class="btn-row" style="margin-top:6px;">
      <button class="btn-muted" onclick="toggleRunList()">配達済み案件</button>
      <button onclick="addRun()">追加</button>
    </div>

    <div id="runList" class="runlist"></div>
  </div>

  

  <!-- 売上カレンダー（直近31日・軽量） -->
  <div class="card" id="calendarCard">
    <div class="center-title clickable" id="calendarTitle" style="font-size:16px;">売上カレンダー</div>
    <button type="button" id="calendarToggle" class="btn small" style="margin-top:10px;">表示する</button>

<!-- クエスト & 現金回収 & メモ -->
  <div class="card">
    <div class="center-title" style="font-size:16px;">クエスト & 今日のメモ & 現金チップ</div>
    <div class="row" style="margin-top:6px;">
      <div>
        <div class="label">クエスト金額 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputQuest" placeholder="例: 1200" />
      </div>
      <div>
        <div class="label">現金チップ (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCashOnly" placeholder="例: 500" />
      </div>
    </div>
    <div class="btn-row">
      <button class="btn-quest" onclick="addQuest()">クエストを追加</button>
      <button class="btn-cash" onclick="addCashOnly()">現金チップ</button>
    </div>
    <div class="label" style="margin-top:6px;">今日のメモ（雨 / 休日 / ブースト など）</div>
    <textarea id="dailyNote" placeholder="例: 雨クエ中 / 夕方からブースト強め など"></textarea>
  </div>

  <!-- リセット / 更新 -->
  <div class="card" style="text-align:center; margin-bottom:24px;">
    <div class="btn-row" style="justify-content:center;">
      <button class="btn-danger" onclick="resetAll()" style="max-width:160px;">リセット</button>
      <button onclick="location.reload()" style="max-width:160px;">更新</button>
    </div>
  </div>

  <pre id="debugBox"></pre>
  <div id="toast" class="toast"></div>

  <script>
/**
 * delivery drill tracker v10 (single input, 4am boundary, goals, prev day, list accordion)
 */
(() => {
  // ===== Debug box: show only on error (enable manual by localStorage DDT_DEBUG=true) =====
  const debugBox = document.getElementById("debugBox");
  const safeLSGet = (k) => { try { return localStorage.getItem(k); } catch(e){ return null; } };
  const DEBUG_ALWAYS = (safeLSGet("DDT_DEBUG") === "true");
  const showDebug = () => debugBox.classList.add("show");
  const log = (msg) => { debugBox.textContent += msg + "\n"; };

  if (DEBUG_ALWAYS) showDebug();

  window.onerror = (m, src, line, col) => {
    showDebug();
    log("❌ window.onerror");
    log(String(m));
    log(`${src || ""}  ${line}:${col}`);
  };
  window.addEventListener("unhandledrejection", (e) => {
    showDebug();
    log("❌ unhandledrejection");
    log(String(e.reason));
  });

  // ===== Helpers =====
  const el = (id) => document.getElementById(id);

  const num = (v) => {
    const s = (v ?? "").toString().replace(/[^\d-]/g, "");
    const n = parseInt(s || "0", 10);
    return Number.isFinite(n) ? n : 0;
  };

  const uid = () => "r_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);

  const toDateStr = (ts) => {
    const d = new Date(ts || Date.now());
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  };

  // 4:00 boundary business day key
  const businessDayKey = (ts) => {
    const d = new Date(ts);
    const h = d.getHours();
    const base = new Date(d);
    if (h < 4) base.setDate(base.getDate() - 1);
    return toDateStr(base.getTime());
  };

  const businessWindow = (dayKey) => {
    const [y,m,dd] = dayKey.split("-").map(x => parseInt(x,10));
    const start = new Date(y, m-1, dd, 4, 0, 0, 0).getTime();
    const end = start + 24*60*60*1000;
    return { start, end };
  };

  const formatStamp = (ts) => {
    const d = new Date(ts);
    return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  };

  const yen = (n) => (num(n)).toLocaleString();

  const calcRates = (amount, minutes) => {
    const t = num(minutes);
    const a = num(amount);
    if (t <= 0) return { perMin: 0, perHour: 0 };
    const perMin = Math.round(a / t);
    const perHour = Math.round(a / (t / 60));
    return { perMin, perHour };
  };

  // ===== Store =====
  const STATE_KEY = "deliveryDrillState_v11";
  const baseState = {
    runsLog: [],
    questLog: [],
    cashOnlyLog: [],
    note: "",
    goals: { runs: null, amount: null },
    onlineByDay: {},
    onlineStartAt: null
  };

  const load = () => {
    try {
      const raw = localStorage.getItem(STATE_KEY);
      if (!raw) return structuredClone(baseState);
      const s = Object.assign({}, baseState, JSON.parse(raw));

      s.runsLog = Array.isArray(s.runsLog) ? s.runsLog : [];
      s.questLog = Array.isArray(s.questLog) ? s.questLog : [];
      s.cashOnlyLog = Array.isArray(s.cashOnlyLog) ? s.cashOnlyLog : [];
      s.note = (s.note ?? "").toString();
      s.onlineByDay = (s.onlineByDay && typeof s.onlineByDay === "object") ? s.onlineByDay : {};
      s.onlineStartAt = (typeof s.onlineStartAt === "number") ? s.onlineStartAt : null;

      const g = s.goals || {};
      s.goals = {
        runs: (g.runs === null || g.runs === undefined || g.runs === "") ? null : num(g.runs),
        amount: (g.amount === null || g.amount === undefined || g.amount === "") ? null : num(g.amount)
      };

      s.runsLog = s.runsLog.map(r => ({
        id: String(r.id || uid()),
        ts: (typeof r.ts === "number") ? r.ts : Date.now(),
        amount: num(r.amount),
        minutes: num(r.minutes),
        cash: num(r.cash),
        count: num(r.count),
        distance: num(r.distance),
        online: (r.online === false) ? false : true
      }));

      s.questLog = s.questLog.map(q => ({
        id: String(q.id || uid()),
        ts: (typeof q.ts === "number") ? q.ts : Date.now(),
        amount: num(q.amount)
      }));

      s.cashOnlyLog = s.cashOnlyLog.map(c => ({
        id: String(c.id || uid()),
        ts: (typeof c.ts === "number") ? c.ts : Date.now(),
        amount: num(c.amount)
      }));

      return s;
    } catch(e) {
      return structuredClone(baseState);
    }
  };

  const save = (s) => {
    try { localStorage.setItem(STATE_KEY, JSON.stringify(s)); } catch(e) {}
  };

  let state = load();

  // ===== Online time tracking (ONLINE_TIME_DIFF_MODEL) =====
  function msToHHMM(ms){
    const m = Math.max(0, Math.floor(ms/60000));
    const hh = String(Math.floor(m/60)).padStart(2,"0");
    const mm = String(m%60).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function getOnlineMs(dayKey){
    return num(state.onlineByDay?.[dayKey] || 0);
  }
  function addOnlineMs(dayKey, ms){
    if (!state.onlineByDay || typeof state.onlineByDay !== "object") state.onlineByDay = {};
    state.onlineByDay[dayKey] = num(state.onlineByDay[dayKey] || 0) + Math.max(0, ms);
  }
  function allocateElapsedAcrossDays(fromTs, toTs){
    if (!(typeof fromTs==="number") || !(typeof toTs==="number") || toTs <= fromTs) return;
    let cur = fromTs;
    while (cur < toTs){
      const curKey = businessDayKey(cur);
      const win = businessWindow(curKey);
      const segEnd = Math.min(toTs, win.end);
      addOnlineMs(curKey, segEnd - cur);
      cur = segEnd;
    }
  }
  function reconcileOnlineToNow(){
    if (state.onlineStartAt !== null){
      const now = Date.now();
      allocateElapsedAcrossDays(state.onlineStartAt, now);
      state.onlineStartAt = now;
      save(state);
    }
  }
  function isOnlineRunning(){ return state.onlineStartAt !== null; }
  function toggleOnlineTracking(){
    if (isOnlineRunning()){
      const now = Date.now();
      allocateElapsedAcrossDays(state.onlineStartAt, now);
      state.onlineStartAt = null;
      save(state);
      showToast("ONLINE計測：停止したよ");
    } else {
      state.onlineStartAt = Date.now();
      save(state);
      showToast("ONLINE計測：開始したよ");
    }
    renderTop();
    syncOnlineButtons();
  }
  reconcileOnlineToNow();
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
      if (isOnlineRunning()) reconcileOnlineToNow();
    }
  });

  // ===== Online tracking buttons (ONLINE_TIME_DIFF_MODEL) =====
  function syncOnlineButtons(){
    const running = isOnlineRunning();
    el("btnOnline").classList.toggle("active", running);
    el("btnOffline").classList.toggle("active", !running);
  }

  function startOnlineTracking(){
    if (!isOnlineRunning()){
      state.onlineStartAt = Date.now();
      save(state);
      showToast("ONLINE計測：開始したよ");
      renderTop();
    }
    syncOnlineButtons();
  }

  function stopOnlineTracking(){
    if (isOnlineRunning()){
      const now = Date.now();
      allocateElapsedAcrossDays(state.onlineStartAt, now);
      state.onlineStartAt = null;
      save(state);
      showToast("ONLINE計測：停止したよ");
      renderTop();
    }
    syncOnlineButtons();
  }

    // 互換用（旧 onclick などが残っても動くように）
  function setOnline(v){ (v ? startOnlineTracking : stopOnlineTracking)(); }

el("btnOnline").addEventListener("click", startOnlineTracking);
  el("btnOffline").addEventListener("click", stopOnlineTracking);

  // 初期同期
  syncOnlineButtons();

  
  // ===== Calendar toggle (safe: collapsed by default) =====
  let calendarOpen = false;
  function setCalendarOpen(v){
    calendarOpen = !!v;
    const wrap = el("calendarWrap");
    const btn = el("calendarToggle");
    if (wrap) wrap.style.display = calendarOpen ? "block" : "none";
    if (btn) btn.textContent = calendarOpen ? "閉じる" : "表示する";
    if (calendarOpen) renderCalendar();
  }
  const calTitle = document.getElementById("calendarTitle");
  const calBtn = document.getElementById("calendarToggle");
  if (calTitle) calTitle.addEventListener("click", () => setCalendarOpen(!calendarOpen));
  if (calBtn) calBtn.addEventListener("click", () => setCalendarOpen(!calendarOpen));
  // 初期は閉じる
  setCalendarOpen(false);

// ===== Toast =====
  let toastTimer = null;
  const showToast = (msg) => {
    const t = el("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove("show"), 5000);
  };

  // ===== Aggregation by business day =====
  function totalsForDay(dayKey) {
    const { start, end } = businessWindow(dayKey);

    const runs = state.runsLog.filter(r => r.ts >= start && r.ts < end);
    const quest = state.questLog.filter(q => q.ts >= start && q.ts < end);
    const cashOnly = state.cashOnlyLog.filter(c => c.ts >= start && c.ts < end);

    const runsCount = runs.length;
    const deliveries = runs.reduce((acc,r) => acc + (r.count || 0), 0);
    const minutesTotal = runs.reduce((acc,r) => acc + (r.minutes || 0), 0);

    const classAmount = runs.reduce((acc,r) => acc + (r.amount || 0), 0);
    const questAmount = quest.reduce((acc,q) => acc + (q.amount || 0), 0);
    const totalAmount = classAmount + questAmount;

    const cashFromRuns = runs.reduce((acc,r) => acc + (r.cash || 0), 0);
    const cashManual = cashOnly.reduce((acc,c) => acc + (c.amount || 0), 0);
    const cashTotal = cashFromRuns + cashManual;

    const onlineMs = getOnlineMs(dayKey) + (isOnlineRunning() ? (()=>{
      const now = Date.now();
      const { start, end } = businessWindow(dayKey);
      const segStart = Math.max(start, state.onlineStartAt ?? now);
      const segEnd = Math.min(end, now);
      return Math.max(0, segEnd - segStart);
    })() : 0);
    const onlineMinutes = Math.floor(onlineMs / 60000);
    const onlineAmount = totalAmount;

    return {
      runs, quest, cashOnly,
      runsCount, deliveries, minutesTotal,
      classAmount, questAmount, totalAmount,
      cashTotal,
      onlineMinutes, onlineAmount
    };
  }

  function getTier(amount) {
    const a = num(amount);
    if (a >= 23000) return 4;
    if (a >= 15000) return 3;
    if (a >= 10000) return 2;
    if (a >= 5000)  return 1;
    return 0;
  }

  function goalsAchieved(dayTotals) {
    const tr = state.goals.runs;
    const ta = state.goals.amount;
    const needRuns = (tr !== null && tr > 0);
    const needAmt  = (ta !== null && ta > 0);

    if (!needRuns && !needAmt) return false;

    const okRuns = !needRuns || (dayTotals.runsCount >= tr);
    const okAmt  = !needAmt  || (dayTotals.totalAmount >= ta);

    return okRuns && okAmt;
  }

  // ===== UI update =====
  function renderTop() {
    const nowKey = businessDayKey(Date.now());
    const today = totalsForDay(nowKey);

    const prevKey = (() => {
      const { start } = businessWindow(nowKey);
      const prevTs = start - 1000;
      return businessDayKey(prevTs);
    })();
    const prev = totalsForDay(prevKey);

    el("questTotalTop").textContent = yen(today.questAmount);
    el("cashTotalTop").textContent  = yen(today.cashTotal);

    el("targetRunsTop").textContent = (state.goals.runs && state.goals.runs > 0) ? `${state.goals.runs}回` : "なし";
    el("targetAmountTop").textContent = (state.goals.amount && state.goals.amount > 0) ? `¥${yen(state.goals.amount)}` : "なし";

    const tier = getTier(today.totalAmount);
    const totalEl = el("totalAmount");
    totalEl.textContent = `¥${yen(today.totalAmount)}`;
    totalEl.classList.remove("tier-0","tier-1","tier-2","tier-3","tier-4");
    totalEl.classList.add(`tier-${tier}`);

    const totalRow = el("totalRow");
    totalRow.classList.toggle("sparkle", tier >= 4);

    const prevHas = (prev.totalAmount > 0) || (prev.runsCount > 0);
    el("prevRow").style.display = prevHas ? "flex" : "none";
    el("prevSummary").textContent = `¥${yen(prev.totalAmount)} / ${prev.runsCount}回`;

    const tr = state.goals.runs;
    el("runsSummary").textContent = (tr && tr > 0) ? `${today.runsCount} / ${tr}回` : `${today.runsCount}回`;

    el("onlineTime").textContent = msToHHMM(today.onlineMinutes * 60000);
    el("activeTime").textContent = msToHHMM(today.minutesTotal * 60000);

    const running = isOnlineRunning();
    el("onlinePill").style.display = running ? "inline-block" : "none";

    const rOnline = calcRates(today.totalAmount, today.onlineMinutes);
    el("onlineHourly").textContent = `¥${yen(rOnline.perHour)}/h`;

    const rActive = calcRates(today.totalAmount, today.minutesTotal);
    el("activeHourly").textContent = `¥${yen(rActive.perHour)}/h`;

    const needRuns = (state.goals.runs !== null && state.goals.runs > 0);
    const needAmt  = (state.goals.amount !== null && state.goals.amount > 0);
    const achRow = el("achRow");
    if (!needRuns && !needAmt) {
      achRow.style.display = "none";
    } else {
      const rr = needRuns ? Math.min(1, today.runsCount / state.goals.runs) : 1;
      const ar = needAmt ? Math.min(1, today.totalAmount / state.goals.amount) : 1;
      const pct = Math.round(((needRuns && needAmt) ? ((rr + ar) / 2) : (needRuns ? rr : ar)) * 100);
      achRow.style.display = "flex";
      el("achPct").textContent = `${pct}%`;
      el("achFill").style.width = `${pct}%`;
    }

    const met = goalsAchieved(today);
    el("topSummaryCard").classList.toggle("goal-met", met);
    totalRow.classList.toggle("goal-met", met);

    renderCalendar();
  }

  // ===== Calendar (last 31 days, lightweight accordion) =====
  function renderCalendar() {
    const box = el("calendarList");
    if (!box) return;

    const now = Date.now();
    const days = [];
    for (let i=0;i<31;i++){
      const ts = now - i*86400000;
      const k = businessDayKey(ts);
      if (!days.includes(k)) days.push(k);
    }

    const rows = days.map(dayKey => {
      const t = totalsForDay(dayKey);
      const d = new Date(businessWindow(dayKey).start);
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const w = ["日","月","火","水","木","金","土"][d.getDay()];
      const label = `${mm}/${dd}(${w})`;

      const onlineRate = calcRates(t.totalAmount, t.onlineMinutes).perHour;
      const activeRate = calcRates(t.totalAmount, t.minutesTotal).perHour;

      return `
        <div class="cal-day" data-day="${dayKey}">
          <div class="cal-head" onclick="toggleCalDay('${dayKey}')">
            <div class="cal-date">${label}</div>
            <div class="cal-metrics">
              <span>売上: ¥${yen(t.totalAmount)}</span>
              <span>件数: ${t.runsCount}回</span>
              <span>オンライン: ¥${yen(onlineRate)}/h</span>
              <span>実働: ¥${yen(activeRate)}/h</span>
            </div>
          </div>

          <div class="cal-details">
            <div class="double-row" style="margin-top:8px;">
              <div class="dbl">
                <div class="k">オンライン時間</div>
                <div class="v">${msToHHMM(t.onlineMinutes*60000)}</div>
              </div>
              <div class="dbl">
                <div class="k">実働時間</div>
                <div class="v">${msToHHMM(t.minutesTotal*60000)}</div>
              </div>
            </div>

            <button class="cal-btn" onclick="toggleCalRuns(event,'${dayKey}')">
              配達ログを表示（${t.runs.length}件）
            </button>

            <div class="cal-runs" id="calRuns_${dayKey}"></div>
          </div>
        </div>`;
    }).join("");

    box.innerHTML = rows;
  }

  function toggleCalDay(dayKey){
    const node = document.querySelector(`.cal-day[data-day="${dayKey}"]`);
    if (!node) return;
    node.classList.toggle("open");
  }

  function toggleCalRuns(ev, dayKey){
    ev.stopPropagation();
    const node = document.querySelector(`.cal-day[data-day="${dayKey}"]`);
    if (!node) return;
    const show = !node.classList.contains("showruns");
    node.classList.toggle("showruns", show);
    if (show) renderCalRuns(dayKey);
  }

  function renderCalRuns(dayKey){
    const box = el(`calRuns_${dayKey}`);
    if (!box) return;
    const t = totalsForDay(dayKey);
    const list = [...t.runs].sort((a,b)=> (b.ts - a.ts));

    if (list.length === 0){
      box.innerHTML = `<div class="label">配達ログはありません。</div>`;
      return;
    }

    const CHUNK = 40;
    const slice = list.slice(0, CHUNK);
    const htmlChunk = slice.map(r => {
      const stamp = formatStamp(r.ts);
      const rates = calcRates(num(r.amount), num(r.minutes));
      return `
        <div class="run-item" style="margin-top:8px;">
          <div class="run-head" style="cursor:default;">
            <div class="left">
              <div class="stamp">${stamp}</div>
              <div class="mini">金額: ¥${yen(r.amount)}｜時間: ${num(r.minutes)}分｜時給換算: ¥${yen(rates.perHour)}/h</div>
            </div>
          </div>
        </div>`;
    }).join("");

    const more = (CHUNK < list.length)
      ? `<button class="cal-btn" onclick="loadMoreCalRuns(event,'${dayKey}',${CHUNK})">さらに表示（残り ${list.length-CHUNK}件）</button>`
      : "";

    box.innerHTML = htmlChunk + more;
  }

  function loadMoreCalRuns(ev, dayKey, from){
    ev.stopPropagation();
    const box = el(`calRuns_${dayKey}`);
    if (!box) return;
    const t = totalsForDay(dayKey);
    const list = [...t.runs].sort((a,b)=> (b.ts - a.ts));
    const CHUNK = 40;

    // remove existing more button
    const btn = box.querySelector("button.cal-btn");
    if (btn) btn.remove();

    const slice = list.slice(from, from+CHUNK);
    const htmlChunk = slice.map(r => {
      const stamp = formatStamp(r.ts);
      const rates = calcRates(num(r.amount), num(r.minutes));
      return `
        <div class="run-item" style="margin-top:8px;">
          <div class="run-head" style="cursor:default;">
            <div class="left">
              <div class="stamp">${stamp}</div>
              <div class="mini">金額: ¥${yen(r.amount)}｜時間: ${num(r.minutes)}分｜時給換算: ¥${yen(rates.perHour)}/h</div>
            </div>
          </div>
        </div>`;
    }).join("");

    box.insertAdjacentHTML("beforeend", htmlChunk);

    const next = from + CHUNK;
    if (next < list.length){
      box.insertAdjacentHTML("beforeend", `<button class="cal-btn" onclick="loadMoreCalRuns(event,'${dayKey}',${next})">さらに表示（残り ${list.length-next}件）</button>`);
    }
  }


  // ===== Run list (accordion) =====
  function toggleRunList() {
    const box = el("runList");
    box.classList.toggle("open");
    if (box.classList.contains("open")) renderRunList();
  }

  function renderRunList() {
    const box = el("runList");
    if (!box || !box.classList.contains("open")) return;

    const nowKey = businessDayKey(Date.now());
    const today = totalsForDay(nowKey);

    const list = [...today.runs].sort((a,b) => (b.ts - a.ts)).slice(0, 300);

    if (list.length === 0) {
      box.innerHTML = `<div class="label">まだ配達記録はありません。</div>`;
      return;
    }

    box.innerHTML = list.map(r => {
      const stamp = formatStamp(r.ts);
      const total = num(r.amount);
      const t = num(r.minutes);
      const rates = calcRates(total, t);
      const pm = rates.perMin ? `¥${yen(rates.perMin)}/分` : `-`;
      const ph = rates.perHour ? `¥${yen(rates.perHour)}/h` : `-`;
      const onlineTag = (r.online !== false) ? "オンライン" : "オフライン";
      const sub = `${onlineTag}｜件数:${num(r.count)}｜現金:${yen(r.cash)}｜時給換算:${ph}｜分単価:${pm}`;

      return `
        <div class="run-item" data-id="${r.id}">
          <div class="run-head" onclick="toggleRunItem('${r.id}')">
            <div class="left">
              <div class="stamp">${stamp}</div>
              <div class="mini">${sub}</div>
            </div>
            <div class="caret">▾</div>
          </div>

          <div class="run-body">
            <div class="grid">
              <div>
                <div class="label">金額</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${num(r.amount)}" data-f="amount" />
              </div>
              <div>
                <div class="label">時間(分)</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${num(r.minutes)}" data-f="minutes" />
              </div>
              <div>
                <div class="label">現金</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${num(r.cash)}" data-f="cash" />
              </div>
              <div>
                <div class="label">件数</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${num(r.count)}" data-f="count" />
              </div>
              <div>
                <div class="label">走行距離(km)</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${num(r.distance)}" data-f="distance" />
              </div>
              <div>
                <div class="label">稼働</div>
                <select data-f="online">
                  <option value="1" ${r.online !== false ? "selected" : ""}>オンライン</option>
                  <option value="0" ${r.online === false ? "selected" : ""}>オフライン</option>
                </select>
              </div>
            </div>

            <div class="actions">
              <button class="btn-goal" onclick="saveRunEdit('${r.id}')">保存</button>
              <button class="btn-danger" onclick="deleteRun('${r.id}')">削除</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  function toggleRunItem(id) {
    const item = document.querySelector(`.run-item[data-id="${id}"]`);
    if (!item) return;
    item.classList.toggle("open");
    const caret = item.querySelector(".caret");
    if (caret) caret.textContent = item.classList.contains("open") ? "▴" : "▾";
  }

  // ===== Add / Edit / Delete =====
  function addRun() {
    const amount = num(el("inputAmount").value);
    const minutes = num(el("inputTime").value);
    const cash = num(el("inputCash").value);
    const count = num(el("inputCount").value);
    const distance = num(el("inputDistance").value);

    if (count <= 0) return;
    if (amount <= 0) return;

    const ts = Date.now();
    const entry = {
      id: uid(),
      ts,
      amount,
      minutes,
      cash,
      count,
      distance,
      online: true
    };

    state.runsLog.push(entry);

    el("inputAmount").value = "";
    el("inputTime").value = "";
    el("inputCash").value = "";
    el("inputDistance").value = "";

    save(state);
    renderTop();

    if (el("runList").classList.contains("open")) renderRunList();

    const dayKey = businessDayKey(ts);
    const today = totalsForDay(dayKey);
    const rate = calcRates(amount, minutes);
    const msg =
`おつかれ！あと何件やろう！
今回: 時給 ¥${yen(rate.perHour)}/h / 分単価 ¥${yen(rate.perMin)}/分
今日: 総売上 ¥${yen(today.totalAmount)} / 配達回数 ${today.runsCount}回`;
    showToast(msg);
  }

  function saveRunEdit(id) {
    const item = document.querySelector(`.run-item[data-id="${id}"]`);
    if (!item) return;

    const get = (f) => {
      const node = item.querySelector(`[data-f="${f}"]`);
      if (!node) return 0;
      if (f === "online") return (node.value === "1");
      return num(node.value);
    };

    const amount = get("amount");
    const minutes = get("minutes");
    const cash = get("cash");
    const count = get("count");
    const distance = get("distance");
    const online = get("online");

    if (count <= 0) return;
    if (amount <= 0) return;

    const idx = state.runsLog.findIndex(r => r.id === id);
    if (idx < 0) return;

    const prev = state.runsLog[idx];
    state.runsLog[idx] = {
      id: prev.id,
      ts: prev.ts,
      amount,
      minutes,
      cash,
      count,
      distance,
      online
    };

    save(state);
    renderTop();
    renderRunList();
  }

  function deleteRun(id) {
    const idx = state.runsLog.findIndex(r => r.id === id);
    if (idx < 0) return;
    state.runsLog.splice(idx, 1);
    save(state);
    renderTop();
    renderRunList();
  }

  // ===== Quest / Cash only =====
  function addQuest() {
    const q = num(el("inputQuest").value);
    if (q <= 0) return;
    state.questLog.push({ id: uid(), ts: Date.now(), amount: q });
    el("inputQuest").value = "";
    save(state);
    renderTop();
    if (el("runList").classList.contains("open")) renderRunList();
  }

  function addCashOnly() {
    const c = num(el("inputCashOnly").value);
    if (c <= 0) return;
    state.cashOnlyLog.push({ id: uid(), ts: Date.now(), amount: c });
    el("inputCashOnly").value = "";
    save(state);
    renderTop();
  }

  // ===== Goals =====
  function setGoals() {
    const r = num(el("inputTargetRuns").value);
    const a = num(el("inputTargetAmount").value);

    const rawR = el("inputTargetRuns").value.trim();
    const rawA = el("inputTargetAmount").value.trim();

    if (rawR !== "") state.goals.runs = (r > 0) ? r : null;
    if (rawA !== "") state.goals.amount = (a > 0) ? a : null;

    el("inputTargetRuns").value = "";
    el("inputTargetAmount").value = "";

    save(state);
    renderTop();

    const nowKey = businessDayKey(Date.now());
    const today = totalsForDay(nowKey);
    if (goalsAchieved(today)) {
      showToast("目標達成！！！！！✨\n今日は勝ち。");
    }
  }

  function clearGoals() {
    state.goals = { runs: null, amount: null };
    save(state);
    renderTop();
  }

  // ===== Reset =====
  function resetAll() {
    if (!confirm("本当に今日の記録を全部リセットしますか？（※4時区切りの『今日』だけ消える）")) return;

    const todayKey = businessDayKey(Date.now());
    const { start, end } = businessWindow(todayKey);

    state.runsLog = state.runsLog.filter(r => !(r.ts >= start && r.ts < end));
    state.questLog = state.questLog.filter(q => !(q.ts >= start && q.ts < end));
    state.cashOnlyLog = state.cashOnlyLog.filter(c => !(c.ts >= start && c.ts < end));
    state.note = "";
    el("dailyNote").value = "";

    save(state);
    renderTop();
    if (el("runList").classList.contains("open")) renderRunList();
    showToast("今日の分だけリセットした。");
  }

  // ===== Note =====
  el("dailyNote").value = state.note || "";
  el("dailyNote").addEventListener("input", () => {
    state.note = el("dailyNote").value;
    save(state);
  });

  // ===== Expose actions =====
  Object.assign(window, {
    setOnline,
    toggleRunList,
    toggleRunItem,
    addRun,
    saveRunEdit,
    deleteRun,
    addQuest,
    addCashOnly,
    setGoals,
    clearGoals,
    resetAll,
    toggleOnlineTracking,
    renderCalendar,
    toggleCalDay,
    toggleCalRuns,
    renderCalRuns,
    loadMoreCalRuns
  });

  renderTop();
})();
  </script>
</body>
</html>
