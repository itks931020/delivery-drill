<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>配達ドリルトラッカー v12.5</title>
<style>
:root{
  --bg:#050816;--card:#141a2b;--text:#f5f5f5;--muted:#9ca3af;
  --b1:rgba(148,163,184,.16);--b2:rgba(148,163,184,.18);
  --glow:rgba(59,130,246,.35);
  --ok:#22c55e; --warn:#facc15; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;padding:10px 10px 84px;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:radial-gradient(circle at top,#182848 0,#050816 55%,#02030a 100%);
  color:var(--text);
}
h1{font-size:20px;margin:0 0 4px}
.sub{font-size:11px;color:var(--muted);margin:0 0 8px}
.card{
  background:linear-gradient(135deg,rgba(20,26,43,.95),rgba(9,12,24,.98));
  border-radius:14px;padding:10px;margin-bottom:10px;
  border:1px solid rgba(59,169,255,.10);
  box-shadow:0 18px 35px rgba(0,0,0,.8);
  position:relative;overflow:hidden;
}
.card.sparkle::before,.card.sparkle::after{
  content:"";position:absolute;inset:-40%;
  background:
    radial-gradient(circle at 20% 30%,rgba(59,169,255,.12),transparent 55%),
    radial-gradient(circle at 70% 60%,rgba(168,85,247,.10),transparent 55%);
  filter:blur(20px);pointer-events:none;opacity:.7;
  animation:spark 6.2s ease-in-out infinite alternate;
}
.card.sparkle::after{opacity:.45;transform:rotate(-8deg);animation-duration:4.6s}
@keyframes spark{from{transform:translate3d(-8%,-6%,0) rotate(10deg)}to{transform:translate3d(8%,6%,0) rotate(10deg)}}

.goal-met{
  border-color:rgba(250,204,21,.85)!important;
  box-shadow:0 0 0 1px rgba(250,204,21,.16),0 18px 35px rgba(0,0,0,.8)!important;
  background:linear-gradient(135deg,rgba(50,35,0,.45),rgba(20,26,43,.95),rgba(9,12,24,.98))!important;
}
.row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.dash{
  background:rgba(2,6,23,.18);
  border:1px solid var(--b1);
  border-radius:12px;padding:10px;
}
.label{font-size:11px;color:var(--muted)}
.dash-value{font-size:22px;font-weight:800;margin-top:2px}

input[type="text"],textarea,select{
  width:100%;border-radius:12px;border:1px solid var(--b2);
  background:rgba(2,6,23,.25);color:var(--text);
  padding:10px;font-size:16px;outline:none;
}
textarea{min-height:60px;resize:vertical}
select{appearance:auto}

button{
  border:none;border-radius:999px;padding:10px;font-weight:900;cursor:pointer;
  color:#fff;background:linear-gradient(90deg,#3b82f6,#06b6d4);
  box-shadow:0 10px 22px var(--glow);font-size:13px;
}
button:active{transform:translateY(1px)}
.btn-muted{
  background:rgba(148,163,184,.16);
  box-shadow:none;border:1px solid rgba(148,163,184,.18);
  color:rgba(226,232,240,.95);
}
.btn-goal{background:linear-gradient(90deg,#a855f7,#3b82f6);box-shadow:0 8px 18px rgba(168,85,247,.38)}
.btn-quest{background:linear-gradient(90deg,#3b82f6,#06b6d4);box-shadow:0 8px 18px rgba(59,130,246,.55)}
.btn-cash{background:linear-gradient(90deg,#f97316,#facc15);box-shadow:0 8px 18px rgba(249,115,22,.55)}
.btn-danger{background:linear-gradient(90deg,#ef4444,#f97316);box-shadow:0 8px 18px rgba(239,68,68,.45)}

.btn-row{display:flex;gap:8px;margin-top:6px;justify-content:center}
.btn-row button{flex:1;width:auto;text-align:center}

.center-title{text-align:center;font-weight:950;letter-spacing:.02em;margin-bottom:6px}
.top-row{
  padding:8px 10px;border-radius:12px;
  background:radial-gradient(circle at top,#3b82f6 0,#020617 55%);
  border:1px solid rgba(59,130,246,.5);text-align:center;
}
.top-row .label{font-size:12px;color:#e5e7eb}
.top-row .value{font-size:26px;font-weight:900;margin-top:2px;text-shadow:0 10px 22px rgba(0,0,0,.5)}
.triple{display:flex;gap:6px;margin-top:6px}
.triple>div,.double>div{
  flex:1;min-width:0;
  background:rgba(2,6,23,.18);
  border:1px solid var(--b1);
  border-radius:12px;padding:10px;
}
.k{font-size:11px;color:rgba(156,163,175,.95)}
.v{font-size:18px;font-weight:950;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.double{display:flex;gap:6px;margin-top:6px}
.double .v{font-size:16px}

.ach{
  display:flex;align-items:center;gap:10px;justify-content:space-between;
  margin-top:6px;background:rgba(2,6,23,.18);
  border:1px solid var(--b1);border-radius:12px;padding:10px;
}
.achL,.achR{font-size:12px;font-weight:950;white-space:nowrap}
.achBar{flex:1;height:10px;border-radius:999px;background:rgba(148,163,184,.14);overflow:hidden}
.achFill{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#facc15);border-radius:999px}

.runlist{margin-top:8px;display:none}
.runitem{
  background:rgba(2,6,23,.18);border:1px solid var(--b1);
  border-radius:12px;padding:10px;margin-bottom:8px;font-size:15px;
}
.runitem .small{font-size:12px;color:rgba(156,163,175,.95);margin-top:4px}

/* normal toast */
.toast{
  position:fixed;left:12px;bottom:12px;width:calc(100% - 24px);
  background:rgba(15,23,42,.92);
  border:1px solid rgba(59,130,246,.45);
  border-radius:14px;padding:12px;
  font-weight:950;font-size:14px;line-height:1.35;
  box-shadow:0 18px 40px rgba(0,0,0,.75);
  opacity:0;transform:translateY(12px);transition:.18s ease;
  pointer-events:none;max-height:30vh;overflow:auto;
}
.toast.show{opacity:1;transform:translateY(0)}

/* modal toast (must ack) */
.modalOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:flex-end;justify-content:center;
  padding:12px;z-index:9999;
}
.modalOverlay.show{display:flex;}
.modalToast{
  width:min(520px,100%);
  background:rgba(15,23,42,.96);
  border:1px solid rgba(250,204,21,.55);
  border-radius:16px;padding:14px;
  box-shadow:0 18px 50px rgba(0,0,0,.85);
}
.modalToast .ttl{font-weight:950;font-size:14px;margin-bottom:6px}
.modalToast .msg{font-size:13px;color:rgba(226,232,240,.92);line-height:1.45;margin-bottom:10px}
.modalToast .actions{display:flex;gap:8px}
.modalToast .actions button{flex:1}

/* calendar */
.calBtn{
  margin:8px auto 0;width:min(320px,100%);
  padding:10px 12px;border-radius:999px;
  border:1px solid rgba(148,163,184,.22);
  background:rgba(15,23,42,.6);font-weight:950;
  display:flex;align-items:center;justify-content:center;
  color:rgba(226,232,240,.95);
}
#calendarWrap{display:none;margin-top:10px}
.calList{display:flex;flex-direction:column;gap:6px}
.calDay{
  border-radius:12px;padding:10px;
  background:rgba(2,6,23,.20);
  border:1px solid rgba(148,163,184,.18);
}
.calHead{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer}
.calDate{font-weight:950}
.calMetrics{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;text-align:right}
.calMetrics span{font-size:12px;color:rgba(226,232,240,.88)}
.calMemo{margin-top:6px;font-size:12px;color:rgba(226,232,240,.85);display:none}
.calDay.open .calMemo{display:block}
.calDetails{margin-top:6px;display:none}
.calDay.open .calDetails{display:block}
.calRuns{margin-top:8px;display:none}
.calDay.showruns .calRuns{display:block}

/* online indicator */
.onlineBadge{font-size:12px;font-weight:950;color:var(--ok);margin-left:6px}
.onlineTapHint{font-size:11px;color:rgba(156,163,175,.95);margin-top:4px;text-align:center}

/* delivery input layout */
.deliveryGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px;
  margin-top:6px;
}

/* footer reload */
.footerBar{
  position:fixed;
  left:0; right:0; bottom:0;
  padding:10px 12px;
  background:rgba(5,8,22,.92);
  border-top:1px solid rgba(148,163,184,.18);
  z-index:5000;
  backdrop-filter: blur(8px);
}
.footerBar .footerInner{
  width:min(520px,100%);
  margin:0 auto;
  display:flex;
  justify-content:flex-end;
}

</style>
</head>
<body>
<h1>配達ドリルトラッカー</h1>
<div class="sub">午前4時で日付が切り替わる（Uberの締めに合わせる）。金額・時間・件数は手打ち。</div>
<div class="card sparkle" id="topSummaryCard">
<div class="row">
<div class="dash"><div class="label">クエスト合計</div><div class="dash-value">¥<span id="questSum">0</span></div></div>
<div class="dash"><div class="label">現金代引き合計</div><div class="dash-value">¥<span id="cashSum">0</span></div></div>
<div class="dash"><div class="label">目標回数</div><div class="dash-value"><span id="targetRunsLabel">なし</span></div></div>
<div class="dash"><div class="label">目標金額</div><div class="dash-value"><span id="targetAmountLabel">なし</span></div></div>
</div>
<div class="row" style="margin-top:6px;">
<div><div class="label">目標回数（任意）</div><input id="inputTargetRuns" inputmode="numeric" pattern="[0-9]*" placeholder="未設定でもOK" type="text"/></div>
<div><div class="label">目標金額（任意・円）</div><input id="inputTargetAmount" inputmode="numeric" pattern="[0-9]*" placeholder="未設定でもOK" type="text"/></div>
</div>
<div class="btn-row">
<button class="btn-muted" id="btnGoalReset">目標リセット</button>
<button class="btn-goal" id="btnGoalSet">目標設定</button>
</div>
</div>
<div class="card sparkle" id="mainStatsCard">
<div class="top-row">
<div class="label">総売上（クエスト込み）</div>
<div class="value">¥<span id="totalSales">0</span></div>
</div>
<div class="ach" id="achRow" style="display:none;">
<div class="achL">達成率</div>
<div class="achBar"><div class="achFill" id="achFill"></div></div>
<div class="achR" id="achText">0%</div>
</div>
<div class="triple">
<div><div class="k">配達回数</div><div class="v"><span id="runCount">0</span>回</div></div>
<div id="onlineTimeBox"><div class="k">オンライン時間<span class="onlineBadge" id="onlineBadge" style="display:none;">online</span></div><div class="v"><span id="onlineTime">00:00</span></div></div>
<div><div class="k">実働時間</div><div class="v"><span id="workTime">00:00</span></div></div>
</div>
<div class="double">
<div><div class="k">オンライン時給換算</div><div class="v">¥<span id="onlineWage">0</span>/h</div></div>
<div><div class="k">実働時給換算</div><div class="v">¥<span id="workWage">0</span>/h</div></div>
</div>
<div class="onlineTapHint">オンライン時間をタップ：オンライン/オフライン切替・時刻修正</div>
</div>
<div class="card">
<div class="center-title" style="font-size:16px;">配達案件</div>
<div class="deliveryGrid">
<div>
<div class="label">件数（件）</div>
<select id="inputCount">
<option selected="" value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select>
</div>
<div>
<div class="label">金額（円）</div>
<input id="inputAmount" inputmode="numeric" pattern="[0-9]*" placeholder="例: 1320" type="text"/>
</div>
<div>
<div class="label">現金代引き（円）</div>
<input id="inputCashCollected" inputmode="numeric" pattern="[0-9]*" placeholder="例: 300" type="text"/>
</div>
<div>
<div class="label">時間（分）</div>
<input id="inputMinutes" inputmode="numeric" pattern="[0-9]*" placeholder="例: 28" type="text"/>
</div>
</div>
<div class="btn-row">
<button class="btn-muted" id="btnToggleRunList">配達済み案件</button>
<button id="btnAddRun">追加</button>
</div>
<div class="runlist" id="runList"></div>
</div>
<div class="card" id="calendarCard">
<div class="center-title" id="calendarTitle" style="font-size:16px;cursor:pointer;">売上カレンダー</div>
<button class="calBtn" id="calendarToggle" type="button">表示する</button>
<div id="calendarWrap">
<div class="sub" style="margin:0 0 6px;">日別：売上/時間/件数/時給/現金代引き/クエスト ＋ メモ</div>
<div class="calList" id="calendarList"></div>
</div>
</div>
<div class="card">
<div class="center-title" style="font-size:16px;">クエスト &amp; 今日のメモ &amp; 現金チップ</div>
<div class="row" style="margin-top:6px;">
<div><div class="label">クエスト金額（円）</div><input id="inputQuest" inputmode="numeric" pattern="[0-9]*" placeholder="例: 1200" type="text"/></div>
<div><div class="label">現金チップ（円）</div><input id="inputCashTip" inputmode="numeric" pattern="[0-9]*" placeholder="例: 300" type="text"/></div>
</div>
<div style="margin-top:6px;">
<div class="label">今日のメモ</div>
<textarea id="inputMemo" placeholder="メモ"></textarea>
</div>
<div class="btn-row">
<button class="btn-quest" id="btnAddQuest">クエスト追加</button>
<button class="btn-cash" id="btnAddCashTip">現金チップ</button>
</div>
<div class="btn-row">
<button class="btn-danger" id="btnResetQuestToday">クエスト今日分リセット</button>
<button class="btn-danger" id="btnResetAll">全てリセット</button>
</div>
</div>
<div class="card">
<div class="center-title" style="font-size:16px;">オンライン</div>
<div class="btn-row">
<button class="btn-muted" id="btnOffline" type="button">オフライン</button>
<button id="btnOnline" type="button">オンライン</button>
</div>
<div class="sub" id="onlineState" style="margin:6px 0 0;text-align:center;display:none;">オンライン中</div>
</div>
<div class="toast" id="toast"></div>
<!-- modal -->
<div aria-hidden="true" class="modalOverlay" id="modalOverlay">
<div class="modalToast">
<div class="ttl" id="modalTitle">通知</div>
<div class="msg" id="modalMsg">メッセージ</div>
<div class="actions" id="modalActions"></div>
</div>
</div>
<div class="footerBar">
<div class="footerInner">
<button class="btn-muted" id="btnReload" type="button">更新</button>
</div>
</div>
<script>
(() => {
  "use strict";

  const STORE_KEY = "ddt_store_v12";
const safeEl = (id) => {
    const n = document.getElementById(id);
    return n || null;
  };
  const toInt=(s)=>{if(s==null)return 0;const n=parseInt(String(s).replace(/[^\d-]/g,""),10);return Number.isFinite(n)?n:0;};
  const fmtYen=(n)=>String(Math.max(0,Math.round(n))).replace(/\B(?=(\d{3})+(?!\d))/g,",");

  function businessDayKey(ts=Date.now()){
    const d=new Date(ts); d.setMinutes(d.getMinutes()-240);
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),day=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function businessWindow(dayKey){
    const [y,m,d]=dayKey.split("-").map(Number);
    const start=new Date(y,m-1,d,4,0,0,0).getTime();
    return {start,end:start+86400000};
  }
  function todayKey(){return businessDayKey(Date.now());}

  const defaultState={
    runsLog:[], quest:[], cashTip:[],
    goal:{runs:0,amount:0},
    online:{isOn:false,startAt:0,accumulatedMs:0,lastKey:""},
    memos:{}, // {dayKey: text}
    calendarOpen:false
  };

  function structuredClonePoly(obj){ return JSON.parse(JSON.stringify(obj)); }
  function loadState(){
    try{
      const raw=localStorage.getItem(STORE_KEY);
      if(!raw) return structuredClonePoly(defaultState);
      const s=JSON.parse(raw);
      const base=structuredClonePoly(defaultState);
      // merge (shallow)
      const merged = Object.assign(base,s);
      // deep-ish fix
      merged.goal = Object.assign(structuredClonePoly(defaultState.goal), s.goal||{});
      merged.online = Object.assign(structuredClonePoly(defaultState.online), s.online||{});
      merged.memos = Object.assign({}, s.memos||{});
      merged.calendarOpen = !!s.calendarOpen;
      return merged;
    }catch(e){return structuredClonePoly(defaultState);}
  }
  let state = loadState();
  let dirty = false;
  let lastSaveAt = 0;
  const markDirty = ()=>{ dirty = true; };

  function saveState(force=false){
    state.calendarOpen = calendarOpen;
    const now = Date.now();
    if(!force && !dirty && (now - lastSaveAt) < 15000) return;
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){}
    dirty = false;
    lastSaveAt = now;
  }

  // toasts
  let toastTimer=null;
  function showToast(msg){
    const t=safeEl("toast"); if(!t) return;
    t.textContent=msg; t.classList.add("show");
    clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove("show"),5000);
  }

  // modal (must ack)
  function showModal({title="通知", msg="", buttons=[{text:"OK", type:"primary", onClick:()=>{}}]}){
    const ov = safeEl("modalOverlay");
    const ttl = safeEl("modalTitle");
    const mm = safeEl("modalMsg");
    const acts = safeEl("modalActions");
    if(!ov||!ttl||!mm||!acts){ return; }

    ttl.textContent = title;
    mm.textContent = msg;
    acts.innerHTML = "";
    buttons.forEach((b)=>{
      const btn=document.createElement("button");
      btn.textContent=b.text||"OK";
      if(b.type==="muted") btn.className="btn-muted";
      else if(b.type==="danger") btn.className="btn-danger";
      // else default gradient button
      btn.addEventListener("click",()=>{
        // Close first, then run the callback.
        // (Allows callbacks to open another modal using the same overlay.)
        ov.classList.remove("show");
        ov.setAttribute("aria-hidden","true");
        try{ b.onClick && b.onClick(); }catch(e){}
      });
      acts.appendChild(btn);
    });
    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");
  }
  function dayBoundaryResetIfNeeded(){
    const key=todayKey();
    if(state.online.lastKey !== key){
      // reset per business day
      state.online = {isOn:false,startAt:0,accumulatedMs:0,lastKey:key};
      // ensure memo box loads right day
    }
  }

  function totalsForDay(dayKey){
    const {start,end}=businessWindow(dayKey);
    const runs=state.runsLog.filter(r=>r.ts>=start&&r.ts<end);
    const quest=state.quest.filter(q=>q.ts>=start&&q.ts<end);
    const amountSum=runs.reduce((a,r)=>a+(r.amount||0),0);
    const questSum=quest.reduce((a,q)=>a+(q.amount||0),0);
    const sales=amountSum+questSum; // チップは含めない
    const count=runs.reduce((a,r)=>a+(r.count||0),0);
    const workMinutes=runs.reduce((a,r)=>a+(r.minutes||0),0);
    const cashSum=runs.reduce((a,r)=>a+(r.cashCollected||0),0);
    return {sales,count,workMs:workMinutes*60000,questSum,cashSum};
  }

  function currentOnlineMs(){
    dayBoundaryResetIfNeeded();
    const o=state.online;
    let ms=o.accumulatedMs||0;
    if(o.isOn && o.startAt) ms += Date.now()-o.startAt;
    return Math.max(0,ms);
  }
  function fmtHHMM(ms){
    const totalMin=Math.floor(ms/60000);
    const hh=String(Math.floor(totalMin/60)).padStart(2,"0");
    const mm=String(totalMin%60).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  // run list
  let runListOpen=false;
  function renderRunList(){
    const box=safeEl("runList"); if(!box) return;
    const {start,end}=businessWindow(todayKey());
    const runs=state.runsLog.filter(r=>r.ts>=start&&r.ts<end).slice().reverse();
    if(!runs.length){box.innerHTML=`<div class="sub" style="margin:6px 0 0;">まだなし</div>`;return;}
    box.innerHTML=runs.map(r=>{
      const wage=r.minutes>0?Math.floor(r.amount/(r.minutes/60)):0;
      return `<div class="runitem">
        <div><strong>¥${fmtYen(r.amount)}</strong> / ${r.minutes}分 / ${r.count||1}件</div>
        <div class="small">時給換算：¥${fmtYen(wage)}/h　現金代引き：¥${fmtYen(r.cashCollected||0)}</div>
      </div>`;
    }).join("");
  }

  function autoFixOnlineByFirstRunIfNeeded(){
    // Only for today
    const key=todayKey();
    const {start,end}=businessWindow(key);
    const runs=state.runsLog.filter(r=>r.ts>=start&&r.ts<end).slice().sort((a,b)=>a.ts-b.ts);
    if(!runs.length) return;
    const first=runs[0];
    const firstMs=(first.minutes||0)*60000;
    if(!firstMs) return;

    const onlineMs=currentOnlineMs();
    if(onlineMs >= firstMs) return;

    const o=state.online;
    const need = firstMs - onlineMs;

    // If currently on, move startAt earlier
    if(o.isOn && o.startAt){
      o.startAt = o.startAt - need;
    }else{
      // not on -> bump accumulated
      o.accumulatedMs = (o.accumulatedMs||0) + need;
    }
  }

  function addRun(){
    markDirty();
    const minutes=toInt(safeEl("inputMinutes")?.value);
    const amount=toInt(safeEl("inputAmount")?.value);
    const cashCollected=toInt(safeEl("inputCashCollected")?.value);
    const count=Math.max(1,toInt(safeEl("inputCount")?.value)||1);
    if(!minutes || !amount){ showToast("時間（分）と金額（円）を入力してね"); return; }

    // id generation safe
    const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+Math.random();

    state.runsLog.push({id,ts:Date.now(),minutes,amount,cashCollected,count});
    if(safeEl("inputMinutes")) safeEl("inputMinutes").value="";
    if(safeEl("inputAmount")) safeEl("inputAmount").value="";
    if(safeEl("inputCashCollected")) safeEl("inputCashCollected").value="";
    if(safeEl("inputCount")) safeEl("inputCount").value="1";

    // online auto fix (v12)
    autoFixOnlineByFirstRunIfNeeded();

    showToast(`追加：${minutes}分 / ¥${fmtYen(amount)} / ${count}件`);
    updateUI();
  }

  function addQuest(){
    markDirty();
    const a=toInt(safeEl("inputQuest")?.value);
    if(!a){showToast("クエスト金額を入れてね");return;}
    const id=(crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+Math.random();
    state.quest.push({id,ts:Date.now(),amount:a});
    if(safeEl("inputQuest")) safeEl("inputQuest").value="";
    showToast(`クエスト追加：¥${fmtYen(a)}`);
    updateUI();
  }
  function addCashTip(){
    markDirty();
    const a=toInt(safeEl("inputCashTip")?.value);
    if(!a){showToast("現金チップ金額を入れてね");return;}
    const id=(crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+Math.random();
    state.cashTip.push({id,ts:Date.now(),amount:a});
    if(safeEl("inputCashTip")) safeEl("inputCashTip").value="";
    showToast(`現金チップ：¥${fmtYen(a)}（※総売上に入れない）`);
    updateUI();
  }
  function resetQuestToday(){
    markDirty();
    const key=todayKey();
    const {start,end}=businessWindow(key);
    const before=state.quest.length;
    state.quest = state.quest.filter(q=>!(q.ts>=start && q.ts<end));
    const removed = before - state.quest.length;
    showToast(removed>0 ? `今日のクエストをリセット：${removed}件` : "今日のクエストは0件");
    updateUI();
  }

  function setGoal(){
    markDirty();
    state.goal.runs=toInt(safeEl("inputTargetRuns")?.value);
    state.goal.amount=toInt(safeEl("inputTargetAmount")?.value);
    showToast("目標を設定した");
    updateUI();
  }
  function resetGoal(){
    markDirty();
    state.goal={runs:0,amount:0};
    if(safeEl("inputTargetRuns")) safeEl("inputTargetRuns").value="";
    if(safeEl("inputTargetAmount")) safeEl("inputTargetAmount").value="";
    showToast("目標をリセットした");
    updateUI();
  }

  function setOnline(on, mode="manual"){
    markDirty();
    dayBoundaryResetIfNeeded();
    const o=state.online;
    if(on){
      if(!o.isOn){ o.isOn=true; o.startAt=Date.now(); }
    }else{
      if(o.isOn){
        o.accumulatedMs=(o.accumulatedMs||0)+(Date.now()-(o.startAt||Date.now()));
        o.startAt=0; o.isOn=false;
      }
    }
    // ui classes
    const bOn=safeEl("btnOnline"), bOff=safeEl("btnOffline");
    if(bOn && bOff){
      if(o.isOn){
        bOn.classList.remove("btn-muted");
        bOff.classList.add("btn-muted");
      }else{
        bOn.classList.add("btn-muted");
        bOff.classList.remove("btn-muted");
      }
    }
    updateUI();
  }

  function confirmOffline(){
    // Require explicit confirmation before going offline (manual actions)
    if(!state.online.isOn){
      showToast("すでにオフラインだよ");
      return;
    }
    showModal({
      title:"確認",
      msg:"オフラインにする？",
      buttons:[
        {text:"やめる", type:"muted", onClick:()=>{}},
        {text:"OK", type:"primary", onClick:()=>setOnline(false,"manual")}
      ]
    });
  }

  function openOnlineTimeEditor(){
    // default: if online is ON, we allow setting start; if OFF allow setting start/end and compute accumulated
    const key=todayKey();
    dayBoundaryResetIfNeeded();
    const o=state.online;

    // use prompt-like modal with simple text inputs
    showModal({
      title:"オンライン時間",
      msg:"やりたい操作を選んでね。",
      buttons:[
        {text: o.isOn ? "オフライン" : "オンライン", type:"primary", onClick:()=>{
          if(o.isOn) confirmOffline();
          else setOnline(true,"manual");
        }},
        {text:"オンライン時間を手入力", type:"muted", onClick:()=>openTimeInputModal()},
        {text:"閉じる", type:"muted", onClick:()=>{}}
      ]
    });
  }

    function openTimeInputModal(){
    // Online duration input (HH:MM). User inputs the ONLINE TIME itself, not start/end timestamps.
    const ov = safeEl("modalOverlay");
    const ttl = safeEl("modalTitle");
    const mm  = safeEl("modalMsg");
    const acts= safeEl("modalActions");
    if(!ov||!ttl||!mm||!acts) return;

    ttl.textContent = "オンライン時間を手入力";
    dayBoundaryResetIfNeeded();

    const o = state.online;
    const pad=(n)=>String(n).padStart(2,"0");
    const curMs = currentOnlineMs();
    const curMin = Math.floor(curMs/60000);
    const defHH = pad(Math.floor(curMin/60));
    const defMM = pad(curMin%60);

    mm.innerHTML = `
      <div style="font-size:12px;color:rgba(226,232,240,.85);margin-bottom:8px;line-height:1.4;">
        今日（4時区切り）の「オンライン時間」そのものを入れてね。形式は HH:MM
      </div>
      <div>
        <div class="label">オンライン時間（HH:MM）</div>
        <input type="text" id="tmpDur" inputmode="numeric" placeholder="例 02:15" value="${defHH}:${defMM}">
      </div>
      <div style="font-size:11px;color:rgba(156,163,175,.95);margin-top:8px;">
        ※反映すると、いったんオフライン扱いで確定します（必要なら再度オンライン押してOK）
      </div>
    `;

    acts.innerHTML = "";
    const btnCancel = document.createElement("button");
    btnCancel.textContent = "キャンセル";
    btnCancel.className = "btn-muted";
    btnCancel.addEventListener("click", ()=>{
      ov.classList.remove("show");
      ov.setAttribute("aria-hidden","true");
    });

    const btnSave = document.createElement("button");
    btnSave.textContent = "反映";
    btnSave.addEventListener("click", ()=>{
      const s = (safeEl("tmpDur")?.value || "").trim();
      const m = s.match(/^\s*(\d{1,2})\s*:\s*(\d{2})\s*$/);
      if(!m){ showToast("形式が違うよ（HH:MM）"); return; }
      const hh = parseInt(m[1],10), mmv = parseInt(m[2],10);
      if(hh<0 || hh>23 || mmv<0 || mmv>59){ showToast("時間が不正だよ"); return; }

      const durMs = (hh*60 + mmv) * 60000;

      // Apply as fixed accumulated duration for today
      state.online.isOn = false;
      state.online.startAt = 0;
      state.online.accumulatedMs = durMs;
      state.online.lastKey = todayKey();

      ov.classList.remove("show");
      ov.setAttribute("aria-hidden","true");
      showToast("オンライン時間を反映した");
      updateUI();
    });

    acts.appendChild(btnCancel);
    acts.appendChild(btnSave);

    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");
  }
  // calendar
  let calendarOpen=!!state.calendarOpen;
  function setCalendarOpen(v){
    calendarOpen=!!v;
    const wrap=safeEl("calendarWrap");
    const btn=safeEl("calendarToggle");
    if(wrap) wrap.style.display=calendarOpen?"block":"none";
    if(btn) btn.textContent=calendarOpen?"閉じる":"表示する";
    if(calendarOpen) renderCalendar();
    saveState();
  }

  function renderCalendar(){
    const box=safeEl("calendarList"); if(!box) return;
    const days=[],now=Date.now();
    for(let i=0;i<31;i++){
      const key=businessDayKey(now-i*86400000);
      if(!days.includes(key)) days.push(key);
    }
    box.innerHTML=days.map(k=>{
      const t=totalsForDay(k);
      const onlineH = (k===todayKey()) ? (currentOnlineMs()/3600000) : 0;
      const onlineW = onlineH>0 ? Math.floor(t.sales/onlineH) : 0;
      const workH = (t.workMs||0)/3600000;
      const workW = workH>0 ? Math.floor(t.sales/workH) : 0;
      const memo = (state.memos && state.memos[k]) ? state.memos[k] : "";
      return `<div class="calDay" data-day="${k}">
        <div class="calHead">
          <div class="calDate">${k}</div>
          <div class="calMetrics">
            <span>売上: ¥${fmtYen(t.sales)}</span>
            <span>時間: ${fmtHHMM(t.workMs||0)}</span>
            <span>件数: ${fmtYen(t.count)}回</span>
            <span>オンライン: ¥${fmtYen(onlineW)}/h</span>
            <span>実働: ¥${fmtYen(workW)}/h</span>
            <span>現金: ¥${fmtYen(t.cashSum)}</span>
            <span>クエスト: ¥${fmtYen(t.questSum)}</span>
          </div>
        </div>
        <div class="calMemo">${memo ? "メモ："+escapeHtml(memo) : "メモ：（なし）"}</div>
        <div class="calDetails">
          <button type="button" class="calBtn" data-openruns="1">配達ログ（さらに開く）</button>
          <div class="calRuns"></div>
        </div>
      </div>`;
    }).join("");

    box.querySelectorAll(".calDay").forEach(dayEl=>{
      const head=dayEl.querySelector(".calHead");
      const btn=dayEl.querySelector('[data-openruns="1"]');
      const runsBox=dayEl.querySelector(".calRuns");
      const dayKey=dayEl.getAttribute("data-day");

      head.addEventListener("click",()=>dayEl.classList.toggle("open"));

      btn.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        const open=dayEl.classList.toggle("showruns");
        if(open){
          const {start,end}=businessWindow(dayKey);
          const runs=state.runsLog.filter(r=>r.ts>=start&&r.ts<end).slice().reverse();
          if(!runs.length){
            runsBox.innerHTML=`<div class="sub" style="margin:6px 0 0;">その日の配達ログなし</div>`;
          }else{
            runsBox.innerHTML=runs.map(r=>{
              const wage=r.minutes>0?Math.floor(r.amount/(r.minutes/60)):0;
              return `<div class="runitem" style="margin-top:8px;">
                <div><strong>¥${fmtYen(r.amount)}</strong> / ${r.minutes}分 / ${r.count||1}件</div>
                <div class="small">時給換算：¥${fmtYen(wage)}/h　現金代引き：¥${fmtYen(r.cashCollected||0)}</div>
              </div>`;
            }).join("");
          }
          btn.textContent="閉じる";
        }else{
          btn.textContent="配達ログ（さらに開く）";
        }
      });
    });
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function updateUI(){
    dayBoundaryResetIfNeeded();

    const dayKey=todayKey();
    const t=totalsForDay(dayKey);

    // top sums
    if(safeEl("questSum")) safeEl("questSum").textContent=fmtYen(t.questSum);
    if(safeEl("cashSum")) safeEl("cashSum").textContent=fmtYen(t.cashSum);

    const gRuns=toInt(state.goal?.runs||0);
    const gAmt=toInt(state.goal?.amount||0);
    if(safeEl("targetRunsLabel")) safeEl("targetRunsLabel").textContent=gRuns>0?`${gRuns}回`:"なし";
    if(safeEl("targetAmountLabel")) safeEl("targetAmountLabel").textContent=gAmt>0?`¥${fmtYen(gAmt)}`:"なし";

    if(safeEl("totalSales")) safeEl("totalSales").textContent=fmtYen(t.sales);
    if(safeEl("runCount")) safeEl("runCount").textContent=fmtYen(t.count);

    const onlineMs=currentOnlineMs();
    if(safeEl("onlineTime")) safeEl("onlineTime").textContent=fmtHHMM(onlineMs);
    if(safeEl("workTime")) safeEl("workTime").textContent=fmtHHMM(t.workMs);

    const onlineH=onlineMs/3600000, workH=(t.workMs||0)/3600000;
    if(safeEl("onlineWage")) safeEl("onlineWage").textContent=fmtYen(onlineH>0?Math.floor(t.sales/onlineH):0);
    if(safeEl("workWage")) safeEl("workWage").textContent=fmtYen(workH>0?Math.floor(t.sales/workH):0);

    // achievement
    let ach = 0;
    if(gAmt>0) ach = Math.floor((t.sales/gAmt)*100);
    else if(gRuns>0) ach = Math.floor((t.count/gRuns)*100);
    if(gAmt>0||gRuns>0){
      if(safeEl("achRow")) safeEl("achRow").style.display="flex";
      const bar = Math.min(100, Math.max(0, ach));
      if(safeEl("achFill")) safeEl("achFill").style.width=`${bar}%`;
      if(safeEl("achText")) safeEl("achText").textContent=`${Math.max(0, ach)}%`;
    }else{
      if(safeEl("achRow")) safeEl("achRow").style.display="none";
    }

    const met=(gAmt>0&&t.sales>=gAmt)||(gRuns>0&&t.count>=gRuns);
    const main=safeEl("mainStatsCard");
    if(main) main.classList.toggle("goal-met", met);

    // online indicator
    const badge=safeEl("onlineBadge");
    const o=state.online;
    if(badge) badge.style.display = o.isOn ? "inline" : "none";
    const stateEl=safeEl("onlineState");
    if(stateEl) stateEl.style.display = o.isOn ? "block" : "none";

    // runlist if open
    if(runListOpen) renderRunList();

    saveState();
  }
  function bind(){
    // buttons
    safeEl("btnReload")?.addEventListener("click", ()=>{ location.reload(); });
    safeEl("btnAddRun")?.addEventListener("click", addRun);
    safeEl("btnToggleRunList")?.addEventListener("click", ()=>{
      runListOpen=!runListOpen;
      const box=safeEl("runList");
      if(box) box.style.display = runListOpen ? "block" : "none";
      if(runListOpen) renderRunList();
    });

    safeEl("btnAddQuest")?.addEventListener("click", addQuest);
    safeEl("btnAddCashTip")?.addEventListener("click", addCashTip);
    safeEl("btnResetQuestToday")?.addEventListener("click", ()=>{
      showModal({
        title:"確認",
        msg:"今日のクエストをリセットする？（過去日は消えない）",
        buttons:[
          {text:"やめる", type:"muted", onClick:()=>{}},
          {text:"リセット", type:"danger", onClick:()=>resetQuestToday()}
        ]
      });
    });


    safeEl("btnResetAll")?.addEventListener("click", ()=>{
      showModal({
        title:"確認",
        msg:"全ての入力をリセットする？（配達ログ・クエスト・目標・メモ・オンライン時間など全部消える）",
        buttons:[
          {text:"やめる", type:"muted", onClick:()=>{}},
          {text:"リセット", type:"danger", onClick:()=>{
            try{ localStorage.removeItem(STORE_KEY); }catch(e){}
            location.reload();
          }}
        ]
      });
    });    safeEl("btnGoalSet")?.addEventListener("click", setGoal);
    safeEl("btnGoalReset")?.addEventListener("click", resetGoal);

    safeEl("btnOnline")?.addEventListener("click", ()=>setOnline(true,"manual"));
    safeEl("btnOffline")?.addEventListener("click", ()=>confirmOffline());

    // calendar open
    safeEl("calendarTitle")?.addEventListener("click", ()=>setCalendarOpen(!calendarOpen));
    safeEl("calendarToggle")?.addEventListener("click", ()=>setCalendarOpen(!calendarOpen));
    setCalendarOpen(!!state.calendarOpen);

    // online time tap
    safeEl("onlineTimeBox")?.addEventListener("click", openOnlineTimeEditor);

    // memo per day
    const memoBox=safeEl("inputMemo");
    if(memoBox){
      const k=todayKey();
      memoBox.value = (state.memos && state.memos[k]) ? state.memos[k] : "";
      memoBox.addEventListener("input", ()=>{
        const kk=todayKey();
        state.memos = state.memos || {};
        state.memos[kk] = memoBox.value || "";
        markDirty();
        saveState();
      });
    }
  }

  function init(){
    // initialize day key
    state.online.lastKey = state.online.lastKey || todayKey();
    dayBoundaryResetIfNeeded();

    // initialize online buttons styles
    const o=state.online;
    const bOn=safeEl("btnOnline"), bOff=safeEl("btnOffline");
    if(bOn && bOff){
      if(o.isOn){
        bOn.classList.remove("btn-muted");
        bOff.classList.add("btn-muted");
      }else{
        bOn.classList.add("btn-muted");
        bOff.classList.remove("btn-muted");
      }
    }
    bind();
    updateUI();
    setInterval(updateUI, 1000);
  }

  document.addEventListener("DOMContentLoaded", init);

})();
</script>
</body>
</html>
