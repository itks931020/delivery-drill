<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>配達ドリルトラッカー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --card: #141a2b;
      --accent: #3ba9ff;
      --accent-soft: #234567;
      --gold: #ffd700;
      --text: #f5f5f5;
      --muted: #9ca3af;
      --danger: #f97373;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #182848 0, #050816 55%, #02030a 100%);
      color: var(--text);
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
    }
    .sub {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      grid-template-rows: auto auto auto;
      gap: 8px;
      margin-bottom: 4px;
    }
    .dash-item {
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.2);
    }
    .dash-label {
      font-size: 10px;
      color: var(--muted);
    }
    .dash-value {
      font-size: 16px;
      font-weight: 600;
    }
    .dash-total-row {
      grid-column: 1 / 3;
      padding: 6px 8px;
      border-radius: 10px;
      background: radial-gradient(circle at top, #3b82f6 0, #020617 55%);
      border: 1px solid rgba(59,130,246,0.5);
    }
    .dash-total-row .dash-label {
      font-size: 11px;
      color: #e5e7eb;
    }
    .dash-total-row .dash-value {
      font-size: 20px;
      color: var(--gold);
    }

    .card {
      background: linear-gradient(135deg, rgba(20,26,43,0.95), rgba(9,12,24,0.98));
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 18px 35px rgba(0,0,0,0.8);
      border: 1px solid rgba(59,169,255,0.1);
      backdrop-filter: blur(10px);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }
    .label {
      font-size: 11px;
      color: var(--muted);
    }
    .class-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .class-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--muted);
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }
    .row > div { flex: 1; }

    input[type="text"], select, textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 12px; /* 見た目維持 */
      outline: none;
    }
    input::placeholder { color: #6b7280; }

    /* iPhoneの入力ズーム対策：focus中だけ16px（viewport禁止は使わない） */
    input[type="text"]:focus, textarea:focus, select:focus {
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 8px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, #22c55e, #06b6d4);
      color: white;
      font-weight: 600;
      font-size: 13px;
      box-shadow: 0 8px 18px rgba(16,185,129,0.55);
      cursor: pointer;
      margin-top: 4px;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(16,185,129,0.45);
    }

    .status-line {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    .status-line span { margin-right: 6px; }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-inner {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #3ba9ff, #22c55e);
      transition: width 0.25s ease-out;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .btn-row button {
      width: 100%;
      font-size: 12px;
      padding: 7px;
    }
    .btn-quest {
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      box-shadow: 0 8px 18px rgba(59,130,246,0.55);
    }
    .btn-cash {
      background: linear-gradient(90deg, #f97316, #facc15);
      box-shadow: 0 8px 18px rgba(249,115,22,0.55);
    }

    /* ===== 追加：配達済みリスト ===== */
    .btn-delivered {
      background: linear-gradient(90deg, #64748b, #334155);
      box-shadow: 0 8px 18px rgba(100,116,139,0.35);
    }

    .runlist{
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      margin-top: 0;
      padding: 0 8px;
      border: 1px solid rgba(148,163,184,0.0);
      border-radius: 12px;
      background: rgba(2,6,23,0.35);
      transition: max-height .22s ease, opacity .18s ease, margin-top .18s ease, border-color .18s ease, padding .18s ease;
      will-change: max-height, opacity;
    }

    .runlist.open{
      max-height: 1200px;
      opacity: 1;
      margin-top: 8px;
      padding: 8px;
      border-color: rgba(148,163,184,0.22);
    }
    .run-item {
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 8px;
      background: rgba(15,23,42,0.65);
    }
    .run-item:last-child { margin-bottom: 0; }
    .run-item .mini {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .run-item .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 6px;
    }
    .run-item .actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .run-item .actions button {
      margin-top: 0;
      padding: 7px;
      font-size: 12px;
    }
    .btn-save {
      background: linear-gradient(90deg, #22c55e, #06b6d4);
    }
    .btn-del {
      background: linear-gradient(90deg, #ef4444, #f97316);
      box-shadow: 0 8px 18px rgba(239,68,68,0.4);
    }
  </style>
</head>

<body>
  <h1>配達ドリルトラッカー</h1>
  <div class="sub">クラスはあくまで目安。金額・時間・件数は毎回手打ちで記録していく。</div>

  <div class="card">
    <div class="dashboard-grid">
      <div class="dash-item">
        <div class="dash-label">ドリル進捗</div>
        <div class="dash-value"><span id="totalRuns">0</span> / 35回</div>
      </div>
      <div class="dash-item">
        <div class="dash-label">総配達件数</div>
        <div class="dash-value"><span id="totalDeliveries">0</span>件</div>
      </div>
      <div class="dash-item">
        <div class="dash-label">クエスト合計</div>
        <div class="dash-value">¥<span id="questTotalTop">0</span></div>
      </div>
      <div class="dash-item">
        <div class="dash-label">現金回収合計</div>
        <div class="dash-value">¥<span id="cashTotalTop">0</span></div>
      </div>
      <div class="dash-total-row">
        <div class="dash-label">総売上 (クエスト込み・現金除外)</div>
        <div class="dash-value">¥<span id="totalAmount">0</span></div>
      </div>
    </div>
    <div class="label" style="margin-top:6px;">ドリル達成度</div>
    <div class="progress-bar">
      <div id="drillProgress" class="progress-inner"></div>
    </div>
  </div>

  <!-- 600円クラス -->
  <div class="card" style="margin-top:10px;">
    <div class="card-header">
      <div>
        <div class="class-title">600円クラス</div>
        <div class="class-meta">
          <span>目安: 600円 / 20分 / 件</span>
          <span>残り時間をこのクラスで埋める</span>
        </div>
      </div>
      <div class="pill">クラス進捗: <span id="runs600">0</span>回</div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div>
        <div class="label">金額 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputAmount600" placeholder="例: 620" />
      </div>
      <div>
        <div class="label">時間 (分)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputTime600" placeholder="例: 20" />
      </div>
      <div>
        <div class="label">現金回収 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCash600" placeholder="例: 100" />
      </div>
      <div>
        <div class="label">件数 (件)</div>
        <select id="inputCount600">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
    </div>

    <div class="btn-row" style="margin-top:6px;">
      <button class="btn-delivered" onclick="toggleRunList('600')">配達済み</button>
      <button onclick="addClassRun('600')">追加</button>
    </div>
    <div id="runList600" class="runlist"></div>

    <div class="status-line">
      <span>達成回数: <span id="doneRuns600">0</span> / 30回</span>
      <span>実配達件数: <span id="delivered600">0</span>件</span>
      <span>クラス合計: ¥<span id="amount600">0</span></span>
      <span>時間合計: <span id="time600">0</span>分</span>
      <span>推奨回数目安: <span id="suggest600" style="color:var(--gold);">0</span>回</span>
    </div>
    <div class="progress-bar">
      <div id="progress600" class="progress-inner"></div>
    </div>
  </div>

  <!-- 1000円クラス -->
  <div class="card" style="margin-top:10px;">
    <div class="card-header">
      <div>
        <div class="class-title">1000円クラス</div>
        <div class="class-meta">
          <span>目安: 1000円 / 30分 / 件</span>
          <span>目標 6回 (クラスドリル)</span>
        </div>
      </div>
      <div class="pill">クラス進捗: <span id="runs1000">0</span>回</div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div>
        <div class="label">金額 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputAmount1000" placeholder="例: 1050" />
      </div>
      <div>
        <div class="label">時間 (分)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputTime1000" placeholder="例: 30" />
      </div>
      <div>
        <div class="label">現金回収 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCash1000" placeholder="例: 150" />
      </div>
      <div>
        <div class="label">件数 (件)</div>
        <select id="inputCount1000">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
    </div>

    <div class="btn-row" style="margin-top:6px;">
      <button class="btn-delivered" onclick="toggleRunList('1000')">配達済み</button>
      <button onclick="addClassRun('1000')">追加</button>
    </div>
    <div id="runList1000" class="runlist"></div>

    <div class="status-line">
      <span>達成回数: <span id="doneRuns1000">0</span> / 6回</span>
      <span>実配達件数: <span id="delivered1000">0</span>件</span>
      <span>クラス合計: ¥<span id="amount1000">0</span></span>
      <span>時間合計: <span id="time1000">0</span>分</span>
    </div>
    <div class="progress-bar">
      <div id="progress1000" class="progress-inner"></div>
    </div>
  </div>

  <!-- 1500円クラス -->
  <div class="card" style="margin-top:10px;">
    <div class="card-header">
      <div>
        <div class="class-title">1500円クラス</div>
        <div class="class-meta">
          <span>目安: 1500円 / 40分 / 件</span>
          <span>目標 2回 (クラスドリル)</span>
        </div>
      </div>
      <div class="pill">クラス進捗: <span id="runs1500">0</span>回</div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div>
        <div class="label">金額 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputAmount1500" placeholder="例: 1640" />
      </div>
      <div>
        <div class="label">時間 (分)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputTime1500" placeholder="例: 40" />
      </div>
      <div>
        <div class="label">現金回収 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCash1500" placeholder="例: 200" />
      </div>
      <div>
        <div class="label">件数 (件)</div>
        <select id="inputCount1500">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
    </div>

    <div class="btn-row" style="margin-top:6px;">
      <button class="btn-delivered" onclick="toggleRunList('1500')">配達済み</button>
      <button onclick="addClassRun('1500')">追加</button>
    </div>
    <div id="runList1500" class="runlist"></div>

    <div class="status-line">
      <span>達成回数: <span id="doneRuns1500">0</span> / 2回</span>
      <span>実配達件数: <span id="delivered1500">0</span>件</span>
      <span>クラス合計: ¥<span id="amount1500">0</span></span>
      <span>時間合計: <span id="time1500">0</span>分</span>
    </div>
    <div class="progress-bar">
      <div id="progress1500" class="progress-inner"></div>
    </div>
  </div>

  <!-- カスタムクラス -->
  <div class="card" style="margin-top:10px;">
    <div class="card-header">
      <div>
        <div class="class-title">カスタム</div>
        <div class="class-meta">
          <span>金額 & 時間が特殊な案件用</span>
        </div>
      </div>
      <div class="pill">回数: <span id="runsCustom">0</span>回</div>
    </div>
    <div class="row" style="margin-top:6px;">
      <div>
        <div class="label">金額 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCustomAmount" placeholder="例: 2500" />
      </div>
      <div>
        <div class="label">時間 (分)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCustomTime" placeholder="例: 45" />
      </div>
      <div>
        <div class="label">現金回収 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCustomCash" placeholder="例: 300" />
      </div>
      <div>
        <div class="label">件数 (件)</div>
        <select id="inputCustomCount">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
    </div>

    <div class="btn-row" style="margin-top:6px;">
      <button class="btn-delivered" onclick="toggleRunList('custom')">配達済み</button>
      <button onclick="addCustom()">追加</button>
    </div>
    <div id="runListcustom" class="runlist"></div>

    <div class="status-line">
      <span>実配達件数: <span id="deliveredCustom">0</span>件</span>
      <span>クラス合計: ¥<span id="amountCustom">0</span></span>
      <span>平均単価: ¥<span id="avgCustom">0</span></span>
      <span>時間合計: <span id="timeCustom">0</span>分</span>
    </div>
  </div>

  <!-- クエスト & 今日のメモ & 現金回収 -->
  <div class="card" style="margin-top:10px; margin-bottom:10px;">
    <div class="class-title">クエスト & 今日のメモ & 現金回収</div>
    <div class="row" style="margin-top:6px;">
      <div>
        <div class="label">クエスト金額 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputQuest" placeholder="例: 1200" />
      </div>
      <div>
        <div class="label">現金回収 (円)</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*" id="inputCash" placeholder="例: 500" />
      </div>
    </div>
    <div class="btn-row">
      <button class="btn-quest" onclick="addQuest()">クエストを追加</button>
      <button class="btn-cash" onclick="addCash()">現金回収を追加</button>
    </div>
    <div class="status-line">
      <span>クエスト合計: ¥<span id="questOnly">0</span></span>
      <span>現金回収合計: ¥<span id="cashOnly">0</span></span>
    </div>
    <div class="label" style="margin-top:6px;">今日のメモ（雨 / 休日 / ブースト など）</div>
    <textarea id="dailyNote" placeholder="例: 雨クエ中 / 夕方からブースト強め など"></textarea>
  </div>

  <!-- リセットボタン -->
  <div class="card" style="margin-top:8px; margin-bottom:8px; text-align:center;">
    <div class="label" style="margin-bottom:4px;">今日の記録を全部リセット</div>
    <button onclick="resetAll()" style="max-width:260px; margin:0 auto; background:linear-gradient(90deg,#ef4444,#f97316);">
      全リセット（件数・金額・メモ）
    </button>
  </div>

  <!-- 更新ボタン -->
  <div class="card" style="margin-top:8px; margin-bottom:24px; text-align:center;">
    <div class="label" style="margin-bottom:4px;">コード更新後に押す用</div>
    <button onclick="location.reload()" style="max-width:260px; margin:0 auto;">
      ページを更新（最新コードを読み込む）
    </button>
  </div>

  <script>
    const STATE_KEY = "deliveryDrillState_v9_store_core";
    const LEGACY_KEYS = ["deliveryDrillState_v8"];
    // =========================
    // core（DOM依存なし）
    // =========================
    const core = (() => {
      const num = (v) => {
        const s = (v ?? "").toString().replace(/[^\d-]/g, "");
        const n = parseInt(s || "0", 10);
        return Number.isFinite(n) ? n : 0;
      };

      const uid = () => "r_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);

      // YYYY-MM-DD（ローカル）
      const toDateStr = (ts) => {
        const d = new Date(ts || Date.now());
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}`;
      };

      const safeJsonParse = (s, fallback) => {
        try { return JSON.parse(s); } catch(e) { return fallback; }
      };

      // memoに入れる（現行UIに必要な情報を保持）
      const packMemo = (obj) => JSON.stringify(obj || {});
      const unpackMemo = (memo) => {
        if (!memo) return {};
        if (typeof memo === "string") return safeJsonParse(memo, {});
        // もし将来memoがオブジェクトで来ても壊れないように
        if (typeof memo === "object") return memo;
        return {};
      };

      // ===== runsLogを型固定：{id,date,minutes,amount,memo} だけにする =====
      // 旧ログ（key/time/cash/count/ts 等）を新ログに変換
      const migrateRunsLogEntry = (r) => {
        // すでに新形式っぽい
        const isNew = r && typeof r === "object"
          && ("id" in r) && ("date" in r) && ("minutes" in r) && ("amount" in r) && ("memo" in r)
          && !("key" in r) && !("time" in r) && !("cash" in r) && !("count" in r) && !("ts" in r);

        if (isNew) return {
          id: String(r.id || uid()),
          date: String(r.date || toDateStr(Date.now())),
          minutes: num(r.minutes),
          amount: num(r.amount),
          memo: typeof r.memo === "string" ? r.memo : packMemo(r.memo)
        };

        // 旧形式 or 混在形式
        const ts = (r && typeof r.ts === "number") ? r.ts : Date.now();
        const key = r?.key ?? r?.classKey ?? "";
        const time = num(r?.time ?? r?.minutes);
        const cash = num(r?.cash);
        const count = num(r?.count);

        const memoObj = Object.assign(
          {},
          (r && r.memo ? unpackMemo(r.memo) : {}),
          {
            key,
            time,
            cash,
            count,
            ts
          }
        );

        return {
          id: String(r?.id || uid()),
          date: toDateStr(ts),
          minutes: time,
          amount: num(r?.amount),
          memo: packMemo(memoObj)
        };
      };

      // 新形式runsLog -> 現行UI用の「表示/計算用」行に復元（DOM依存なし）
      const toUiRun = (r) => {
        const memo = unpackMemo(r?.memo);
        const ts = (typeof memo.ts === "number") ? memo.ts : Date.now();

        return {
          id: String(r?.id || uid()),
          key: memo.key || "custom",
          amount: num(r?.amount),
          time: num(r?.minutes),       // minutesをtimeとして扱う（UI互換）
          cash: num(memo.cash),
          count: num(memo.count) || 0,
          ts
        };
      };

      // 集計（uiRunsを食う）
      const aggregateFromUiRuns = (uiRuns) => {
        const agg = {
          runs:      { "1500": 0, "1000": 0, "600": 0, custom: 0 },
          delivered: { "1500": 0, "1000": 0, "600": 0, custom: 0 },
          amounts:   { "1500": 0, "1000": 0, "600": 0, custom: 0 },
          times:     { "1500": 0, "1000": 0, "600": 0, custom: 0 }
        };

        for (const r of uiRuns) {
          const k = r.key;
          if (!(k in agg.runs)) continue;
          agg.runs[k] += 1;
          agg.delivered[k] += (r.count || 0);
          agg.amounts[k] += (r.amount || 0);
          agg.times[k] += (r.time || 0);
        }
        return agg;
      };

      // cashは「state.cash」を正として扱うけど、編集/削除時は差分計算が必要
      const getCashFromNewEntry = (entry) => {
        const memo = unpackMemo(entry?.memo);
        return num(memo.cash);
      };

      const getCountFromNewEntry = (entry) => {
        const memo = unpackMemo(entry?.memo);
        return num(memo.count);
      };

      const getKeyFromNewEntry = (entry) => {
        const memo = unpackMemo(entry?.memo);
        return memo.key || "custom";
      };

      const getTsFromNewEntry = (entry) => {
        const memo = unpackMemo(entry?.memo);
        return (typeof memo.ts === "number") ? memo.ts : Date.now();
      };

      const updateNewEntryMemo = (entry, patch) => {
        const memo = unpackMemo(entry?.memo);
        const next = Object.assign({}, memo, patch);
        return Object.assign({}, entry, { memo: packMemo(next) });
      };

      return {
        num,
        uid,
        migrateRunsLogEntry,
        toUiRun,
        aggregateFromUiRuns,
        getCashFromNewEntry,
        getCountFromNewEntry,
        getKeyFromNewEntry,
        getTsFromNewEntry,
        updateNewEntryMemo,
        packMemo,
        unpackMemo,
        toDateStr
      };
    })();

    // =========================
    // store（localStorage直書き禁止）
    // =========================
const store = (() => {
  const baseState = { runsLog: [], quest: 0, cash: 0, note: "" };

  const tryLoad = (key) => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return null;

      const parsed = JSON.parse(raw);
      const s = Object.assign({}, baseState, parsed);

      const list = Array.isArray(s.runsLog) ? s.runsLog : [];
      s.runsLog = list.map(core.migrateRunsLogEntry);

      s.quest = core.num(s.quest);
      s.cash  = core.num(s.cash);
      s.note  = (s.note ?? "").toString();

      return s;
    } catch (e) {
      return null;
    }
  };

  const load = () => {
    // まず新キー
    let s = tryLoad(STATE_KEY);

    // なければ旧キーを順に探す
    if (!s) {
      for (const k of (LEGACY_KEYS || [])) {
        s = tryLoad(k);
        if (s) break;
      }
    }

    return s || Object.assign({}, baseState);
  };

  const save = (state) => {
    const s = Object.assign({}, baseState, state);

    const list = Array.isArray(s.runsLog) ? s.runsLog : [];
    s.runsLog = list.map(core.migrateRunsLogEntry);

    s.quest = core.num(s.quest);
    s.cash  = core.num(s.cash);
    s.note  = (s.note ?? "").toString();

    try {
      localStorage.setItem(STATE_KEY, JSON.stringify(s));
    } catch(e) {}
  };

  return { load, save };
})();

      const save = (state) => {
        // 保存前に runsLog を「型固定」に再整形（保険）
        const s = Object.assign({}, state);
        const list = Array.isArray(s.runsLog) ? s.runsLog : [];
        s.runsLog = list.map(core.migrateRunsLogEntry);

        try {
          localStorage.setItem(STATE_KEY, JSON.stringify(s));
        } catch(e) {}
      };

      return { load, save };
    })();

    // =========================
    // state（アプリの唯一の状態）
    // =========================
    let state = store.load();

    const el = (id) => document.getElementById(id);

    // =========================
    // UI更新（coreの結果をDOMへ）
    // =========================
    function calcTotals() {
      // runsLog（新形式） -> UI用に復元して集計
      const uiRuns = state.runsLog.map(core.toUiRun);
      const a = core.aggregateFromUiRuns(uiRuns);

      const totalRuns =
        a.runs["1500"] + a.runs["1000"] + a.runs["600"] + a.runs.custom;

      const totalDeliveries =
        a.delivered["1500"] + a.delivered["1000"] + a.delivered["600"] + a.delivered.custom;

      const totalClassAmount =
        a.amounts["1500"] + a.amounts["1000"] + a.amounts["600"] + a.amounts.custom;

      const totalAmount = totalClassAmount + (state.quest || 0);

      el("totalRuns").textContent = totalRuns.toString();
      el("totalDeliveries").textContent = totalDeliveries.toString();
      el("totalAmount").textContent = totalAmount.toLocaleString();

      el("questTotalTop").textContent = (state.quest || 0).toLocaleString();
      el("cashTotalTop").textContent  = (state.cash  || 0).toLocaleString();

      const drillPercent = Math.min(100, (totalRuns / 35) * 100);
      el("drillProgress").style.width = drillPercent + "%";

      el("runs1500").textContent = a.runs["1500"].toString();
      el("runs1000").textContent = a.runs["1000"].toString();
      el("runs600").textContent  = a.runs["600"].toString();
      el("runsCustom").textContent = a.runs.custom.toString();

      el("doneRuns1500").textContent = a.runs["1500"].toString();
      el("doneRuns1000").textContent = a.runs["1000"].toString();
      el("doneRuns600").textContent  = a.runs["600"].toString();

      ["1500","1000","600"].forEach(k => {
        el("delivered" + k).textContent = a.delivered[k].toString();
        el("amount" + k).textContent = a.amounts[k].toLocaleString();
        el("time" + k).textContent = a.times[k].toString();
      });

      el("deliveredCustom").textContent = a.delivered.custom.toString();
      el("amountCustom").textContent    = a.amounts.custom.toLocaleString();
      el("timeCustom").textContent      = a.times.custom.toString();

      const p1500 = Math.min(100, (a.runs["1500"] / 2) * 100);
      const p1000 = Math.min(100, (a.runs["1000"] / 6) * 100);
      const p600  = Math.min(100, (a.runs["600"]  / 30) * 100);
      el("progress1500").style.width = p1500 + "%";
      el("progress1000").style.width = p1000 + "%";
      el("progress600").style.width  = p600 + "%";

      const usedTime = a.times["1500"] + a.times["1000"] + a.times["600"] + a.times.custom;
      const targetTime = 750; // 12.5時間
      const remain = Math.max(0, targetTime - usedTime);
      const suggest = Math.floor(remain / 20);
      el("suggest600").textContent = suggest.toString();

      const avg = a.delivered.custom ? Math.round(a.amounts.custom / a.delivered.custom) : 0;
      el("avgCustom").textContent = avg.toLocaleString();

      el("questOnly").textContent = (state.quest || 0).toLocaleString();
      el("cashOnly").textContent  = (state.cash  || 0).toLocaleString();
      el("dailyNote").value       = state.note || "";

      ["600","1000","1500","custom"].forEach(renderRunListIfOpen);
    }

    // =========================
    // 追加（runsLogは新型で保存）
    // =========================
    function addClassRun(key) {
      const amount = core.num(el("inputAmount" + key).value);
      const time   = core.num(el("inputTime" + key).value);
      const cash   = core.num(el("inputCash" + key).value);
      const count  = core.num(el("inputCount" + key).value);

      if (count <= 0) return;
      if (amount <= 0) return;

      const ts = Date.now();
      const entry = {
        id: core.uid(),
        date: core.toDateStr(ts),
        minutes: time,
        amount: amount,
        memo: core.packMemo({ key, cash, count, ts, time })
      };

      state.runsLog.push(entry);

      if (cash > 0) state.cash += cash;

      el("inputAmount" + key).value = "";
      el("inputTime" + key).value   = "";
      el("inputCash" + key).value   = "";

      store.save(state);
      calcTotals();
    }

    function addCustom() {
      const amount = core.num(el("inputCustomAmount").value);
      const time   = core.num(el("inputCustomTime").value);
      const cash   = core.num(el("inputCustomCash").value);
      const count  = core.num(el("inputCustomCount").value);

      if (count <= 0) return;
      if (amount <= 0) return;

      const ts = Date.now();
      const entry = {
        id: core.uid(),
        date: core.toDateStr(ts),
        minutes: time,
        amount: amount,
        memo: core.packMemo({ key: "custom", cash, count, ts, time })
      };

      state.runsLog.push(entry);

      if (cash > 0) state.cash += cash;

      el("inputCustomAmount").value = "";
      el("inputCustomTime").value   = "";
      el("inputCustomCash").value   = "";

      store.save(state);
      calcTotals();
    }

    function addQuest() {
      const q = core.num(el("inputQuest").value);
      if (q <= 0) return;
      state.quest += q;
      el("inputQuest").value = "";
      store.save(state);
      calcTotals();
    }

    function addCash() {
      const c = core.num(el("inputCash").value);
      if (c <= 0) return;
      state.cash += c;
      el("inputCash").value = "";
      store.save(state);
      calcTotals();
    }

    function resetAll() {
      if (!confirm("本当に今日の記録を全部リセットしますか？")) return;
      state = { runsLog: [], quest: 0, cash: 0, note: "" };
      store.save(state);
      calcTotals();
    }

    // =========================
    // 配達済みリスト（開いた時だけ描画）
    // =========================
    function toggleRunList(key) {
      const box = el("runList" + key);
      if (!box) return;

      const willOpen = !box.classList.contains("open");
      box.classList.toggle("open");

      if (willOpen) renderRunList(key);
    }

    function renderRunListIfOpen(key) {
      const box = el("runList" + key);
      if (!box) return;
      if (box.classList.contains("open")) renderRunList(key);
    }

    // 重すぎ対策：描画上限（UIは変えず、内部だけ軽く）
    const MAX_RENDER_PER_CLASS = 300;

    function renderRunList(key) {
      const box = el("runList" + key);
      if (!box) return;

      // 新形式->UI形式へ復元してからフィルタ
      const uiRuns = state.runsLog.map(core.toUiRun);

      const list = uiRuns
        .filter(r => r.key === key)
        .sort((a,b) => (b.ts || 0) - (a.ts || 0))
        .slice(0, MAX_RENDER_PER_CLASS);

      if (list.length === 0) {
        box.innerHTML = `<div class="label">まだこのクラスの配達記録はありません。</div>`;
        return;
      }

      box.innerHTML = list.map(r => {
        const d = new Date(r.ts || Date.now());
        const stamp = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
        return `
          <div class="run-item" data-id="${r.id}">
            <div class="mini">
              <span>${stamp}</span>
              <span>ID: ${r.id.slice(-6)}</span>
            </div>

            <div class="grid">
              <div>
                <div class="label">金額</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${r.amount || 0}" data-f="amount" />
              </div>
              <div>
                <div class="label">時間(分)</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${r.time || 0}" data-f="time" />
              </div>
              <div>
                <div class="label">現金</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${r.cash || 0}" data-f="cash" />
              </div>
              <div>
                <div class="label">件数</div>
                <input type="text" inputmode="numeric" pattern="[0-9]*" value="${r.count || 0}" data-f="count" />
              </div>
            </div>

            <div class="actions">
              <button class="btn-save" onclick="saveRunEdit('${r.id}')">保存</button>
              <button class="btn-del" onclick="deleteRun('${r.id}')">削除</button>
            </div>
          </div>
        `;
      }).join("");
    }

    // =========================
    // 編集/削除（runsLog新型で保持）
    // =========================
    function saveRunEdit(id) {
      const item = document.querySelector(`.run-item[data-id="${id}"]`);
      if (!item) return;

      const get = (f) => core.num(item.querySelector(`[data-f="${f}"]`)?.value);

      const amount = get("amount");
      const time   = get("time");
      const cash   = get("cash");
      const count  = get("count");

      if (count <= 0) return;
      if (amount <= 0) return;

      const idx = state.runsLog.findIndex(r => r.id === id);
      if (idx < 0) return;

      const prevCash = core.getCashFromNewEntry(state.runsLog[idx]);
      state.cash += (cash - prevCash);

      // minutes/amountは新型の正規フィールド、key/cash/count/ts/timeはmemoへ
      const prev = state.runsLog[idx];
      const ts = core.getTsFromNewEntry(prev); // 既存のタイムスタンプは保持
      const key = core.getKeyFromNewEntry(prev);

      let next = {
        id: prev.id,
        date: prev.date,
        minutes: time,
        amount: amount,
        memo: prev.memo
      };

      next = core.updateNewEntryMemo(next, { key, cash, count, ts, time });

      state.runsLog[idx] = next;

      store.save(state);
      calcTotals();
    }

    function deleteRun(id) {
      const idx = state.runsLog.findIndex(r => r.id === id);
      if (idx < 0) return;

      const prevCash = core.getCashFromNewEntry(state.runsLog[idx]);
      state.cash -= prevCash;
      if (state.cash < 0) state.cash = 0;

      state.runsLog.splice(idx, 1);
      store.save(state);
      calcTotals();
    }

    el("dailyNote").addEventListener("input", () => {
      state.note = el("dailyNote").value;
      store.save(state);
    });

    // 初回：ロード後に再保存（移行があったらここで確定）
    store.save(state);
    calcTotals();
  </script>
</body>
</html>